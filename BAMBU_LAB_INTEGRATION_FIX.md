# ๐ง Bambu Lab Integration Fix - Technical Report

## ๐ ะัะฐัะบะพะต ะพะฟะธัะฐะฝะธะต ะฟัะพะฑะปะตะผั

ะะพะปัะทะพะฒะฐัะตะปะธ ัะพะพะฑัะฐะปะธ, ััะพ **ะะ ะะะะฃะข ะฟะพะดะบะปััะธัั ะฟัะธะฝัะตัั Bambu Lab** ะบ ะฟะฐะฝะตะปะธ ัะฟัะฐะฒะปะตะฝะธั, ะฝะตัะผะพััั ะฝะฐ ะฝะฐะปะธัะธะต ะดะพะบัะผะตะฝัะฐัะธะธ ะธ ะธะฝััััะบัะธะน.

## ๐ ะะปัะฑะพะบะพะต ะธััะปะตะดะพะฒะฐะฝะธะต ะฟัะพะฑะปะตะผั

### ะะฐะนะดะตะฝะฝัะต ะฟัะพะฑะปะตะผั:

1. โ **ะะดะฐะฟัะตั ัััะตััะฒะพะฒะฐะป, ะฝะพ ะฝะต ะธัะฟะพะปัะทะพะฒะฐะปัั**
   - ะคะฐะนะป `src/bambu-printer-adapter.js` ะฑัะป ะฟะพะปะฝะพัััั ัะตะฐะปะธะทะพะฒะฐะฝ ั ะบะพััะตะบัะฝะพะน ะปะพะณะธะบะพะน MQTT ะฟะพะดะบะปััะตะฝะธั
   - ะะ: ััะพั ะฐะดะฐะฟัะตั ะะะะะะะ ะฝะต ะฒัะทัะฒะฐะปัั ะธะท ะบะพะดะฐ ะฟัะธะปะพะถะตะฝะธั

2. โ **ะคัะฝะบัะธั testBambuLabConnection ะฑัะปะฐ "ะทะฐะณะปััะบะพะน"**
   - ะ `src/renderer.js` ััะฝะบัะธั `testBambuLabConnection()` ะฟัะพััะพ ััะฐะฒะธะปะฐ ััะฐััั "offline" ะธ ะฒะพะทะฒัะฐัะฐะปะฐ `false`
   - ะะต ะฑัะปะพ ัะตะฐะปัะฝะพะณะพ ะฟะพะดะบะปััะตะฝะธั ัะตัะตะท MQTT

3. โ **ะััััััะฒะพะฒะฐะปะธ IPC ะพะฑัะฐะฑะพััะธะบะธ**
   - ะ `src/main.js` ะฝะต ะฑัะปะพ ะพะฑัะฐะฑะพััะธะบะพะฒ ะดะปั ัะฐะฑะพัั ั Bambu ะฟัะธะฝัะตัะฐะผะธ
   - ะะต ะฑัะปะพ ะผะพััะฐ ะผะตะถะดั renderer ะฟัะพัะตััะพะผ ะธ ะฐะดะฐะฟัะตัะพะผ

4. โ **ะััััััะฒะพะฒะฐะปะธ API ะฒ preload.js**
   - ะะต ะฑัะปะพ ัะบัะฟะพะฝะธัะพะฒะฐะฝะฝัั ััะฝะบัะธะน ะดะปั ัะฐะฑะพัั ั Bambu ะฟะพะดะบะปััะตะฝะธัะผะธ

## โ ะัะฟะพะปะฝะตะฝะฝัะต ะธัะฟัะฐะฒะปะตะฝะธั

### 1. **MQTT ะะตะฝะตะดะถะตั ะฒ main.js** (ะณะปะฐะฒะฝัะน ะฟัะพัะตัั)

**ะะพะฑะฐะฒะปะตะฝะพ:**
```javascript
// ะะผะฟะพัั ะฐะดะฐะฟัะตัะฐ ะธ ะผะตะฝะตะดะถะตั ะฟะพะดะบะปััะตะฝะธะน
const BambuLabAdapter = require('./bambu-printer-adapter.js');
const bambuConnections = new Map(); // printerId -> BambuLabAdapter instance
```

**ะกะพะทะดะฐะฝะฝัะต ััะฝะบัะธะธ:**
- `testBambuConnection(printerData)` - ัะตััะธัะพะฒะฐะฝะธะต ะฟะพะดะบะปััะตะฝะธั ะบ Bambu ะฟัะธะฝัะตัั
- `closeBambuConnection(printerId)` - ะทะฐะบัััะธะต MQTT ะฟะพะดะบะปััะตะฝะธั
- `getBambuPrinterData(printerId)` - ะฟะพะปััะตะฝะธะต ะดะฐะฝะฝัั ะฟัะธะฝัะตัะฐ
- `requestBambuStatus(printerId)` - ะทะฐะฟัะพั ะพะฑะฝะพะฒะปะตะฝะธั ััะฐัััะฐ

**ะคัะฝะบัะธะพะฝะฐะป:**
- ะกะพะทะดะฐะฝะธะต ะธ ััะฐะฝะตะฝะธะต MQTT ะฟะพะดะบะปััะตะฝะธะน
- ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต ะฟัะพัะพะบะพะปะฐ (MQTTS/MQTT)
- Real-time ะฟะตัะตะดะฐัะฐ ะดะฐะฝะฝัั ะฒ renderer ะฟัะพัะตัั
- ะะพััะตะบัะฝะพะต ะทะฐะบัััะธะต ะฟะพะดะบะปััะตะฝะธะน ะฟัะธ ะฒััะพะดะต

### 2. **IPC ะะฑัะฐะฑะพััะธะบะธ ะฒ main.js**

**ะะพะฑะฐะฒะปะตะฝั ะพะฑัะฐะฑะพััะธะบะธ:**
```javascript
ipcMain.handle('test-bambu-connection', async (event, printerData) => {...})
ipcMain.handle('close-bambu-connection', async (event, printerId) => {...})
ipcMain.handle('get-bambu-printer-data', async (event, printerId) => {...})
ipcMain.handle('request-bambu-status', (event, printerId) => {...})
```

**ะะฐะฝะฐะป ะดะปั ะพะฑะฝะพะฒะปะตะฝะธะน:**
```javascript
mainWindow.webContents.send('bambu-printer-update', updateData)
```

### 3. **API ะฒ preload.js**

**ะญะบัะฟะพะฝะธัะพะฒะฐะฝั ะผะตัะพะดั:**
```javascript
testBambuConnection: (printerData) => ipcRenderer.invoke('test-bambu-connection', printerData)
closeBambuConnection: (printerId) => ipcRenderer.invoke('close-bambu-connection', printerId)
getBambuPrinterData: (printerId) => ipcRenderer.invoke('get-bambu-printer-data', printerId)
requestBambuStatus: (printerId) => ipcRenderer.invoke('request-bambu-status', printerId)
onBambuPrinterUpdate: (callback) => ipcRenderer.on('bambu-printer-update', ...)
```

### 4. **ะะตัะตะฟะธัะฐะฝะฐ testBambuLabConnection ะฒ renderer.js**

**ะัะปะพ:**
```javascript
async function testBambuLabConnection(printer, isManualCheck = false) {
    printer.status = 'offline';
    printer.connectionType = 'MQTT (not configured)';
    return false; // ะะกะะะะ ะฒะพะทะฒัะฐัะฐะปะพ false!
}
```

**ะกัะฐะปะพ:**
```javascript
async function testBambuLabConnection(printer, isManualCheck = false) {
    // ะะตะฐะปัะฝะพะต ะฟะพะดะบะปััะตะฝะธะต ัะตัะตะท main ะฟัะพัะตัั
    const result = await window.electronAPI.testBambuConnection({
        id: printer.id,
        name: printer.name,
        ip: printer.ip,
        accessCode: printer.accessCode,
        serialNumber: printer.serialNumber,
        type: 'bambu',
        preferredProtocol: printer.preferredProtocol
    });
    
    if (result.success) {
        printer.status = 'ready';
        printer.connectionType = `MQTT (${result.protocol.toUpperCase()})`;
        // ... ะพะฑะฝะพะฒะปะตะฝะธะต ะดะฐะฝะฝัั
        return true;
    }
}
```

### 5. **ะะพะฑะฐะฒะปะตะฝ ะพะฑัะฐะฑะพััะธะบ ะพะฑะฝะพะฒะปะตะฝะธะน handleBambuPrinterUpdate**

```javascript
function handleBambuPrinterUpdate(updateData) {
    const printer = printers.find(p => p.id === updateData.id);
    if (!printer) return;
    
    // ะะฑะฝะพะฒะปะตะฝะธะต ะดะฐะฝะฝัั ะฟัะธะฝัะตัะฐ ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ
    printer.data = updateData.data;
    printer.status = updateData.status;
    printer.lastUpdate = new Date(updateData.lastUpdate);
    
    updatePrinterDisplay(printer);
    // ...
}
```

### 6. **ะะตัะธะพะดะธัะตัะบะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะดะปั Bambu ะฟัะธะฝัะตัะพะฒ**

**ะะฑะฝะพะฒะปะตะฝะฐ ััะฝะบัะธั startPeriodicUpdates:**
```javascript
updateInterval = setInterval(() => {
    printers.forEach(printer => {
        if (printer.type === 'bambu') {
            // Bambu Lab ะธัะฟะพะปัะทัะตั MQTT, ะทะฐะฟัะฐัะธะฒะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะธะต ััะฐัััะฐ
            if (printer.status !== 'offline') {
                window.electronAPI.requestBambuStatus(printer.id);
            }
        } else if (...) {
            // Klipper ะฟัะธะฝัะตัั ะธัะฟะพะปัะทััั HTTP polling
            updatePrinterData(printer);
        }
    });
}, currentPollingInterval);
```

### 7. **ะะพััะตะบัะฝะพะต ะทะฐะบัััะธะต ะฟะพะดะบะปััะตะฝะธะน**

**ะัะธ ัะดะฐะปะตะฝะธะธ ะฟัะธะฝัะตัะฐ:**
```javascript
async function removePrinter(printerId, event) {
    // ...
    // ะะฐะบัััะธะต MQTT ะฟะพะดะบะปััะตะฝะธั ะดะปั Bambu Lab ะฟัะธะฝัะตัะพะฒ
    if (printer.type === 'bambu') {
        await window.electronAPI.closeBambuConnection(printerId);
    }
    // ...
}
```

**ะัะธ ะทะฐะบัััะธะธ ะฟัะธะปะพะถะตะฝะธั (main.js):**
```javascript
app.on('before-quit', async () => {
    // ะะฐะบัััะธะต ะฒัะตั Bambu Lab ะฟะพะดะบะปััะตะฝะธะน
    for (const [printerId, adapter] of bambuConnections.entries()) {
        await adapter.closeConnection();
    }
    bambuConnections.clear();
});
```

## ๐ฏ ะะตะทัะปััะฐัั

### โ ะงัะพ ัะตะฟะตัั ัะฐะฑะพัะฐะตั:

1. **ะะตะฐะปัะฝะพะต MQTT ะฟะพะดะบะปััะตะฝะธะต** ะบ ะฟัะธะฝัะตัะฐะผ Bambu Lab
2. **ะะฒัะพะผะฐัะธัะตัะบะพะต ะพะฟัะตะดะตะปะตะฝะธะต ะฟัะพัะพะบะพะปะฐ** (MQTTS ะดะปั ะฝะพะฒัั ะฟัะพัะธะฒะพะบ, MQTT ะดะปั ััะฐััั)
3. **Real-time ะพะฑะฝะพะฒะปะตะฝะธั ะดะฐะฝะฝัั**:
   - ะขะตะผะฟะตัะฐัััั (ัะบััััะดะตั, ััะพะป, ะบะฐะผะตัะฐ)
   - ะกัะฐััั ะฟะตัะฐัะธ (ะณะพัะพะฒ, ะฟะตัะฐัะฐะตั, ะฟะฐัะทะฐ, ะพัะธะฑะบะฐ)
   - ะัะพะณัะตัั ะฟะตัะฐัะธ (%)
   - ะะผั ัะฐะนะปะฐ
4. **ะััะธัะพะฒะฐะฝะธะต ััะฟะตัะฝะพะณะพ ะฟัะพัะพะบะพะปะฐ** ะดะปั ะฑััััะพะณะพ ะฟะตัะตะฟะพะดะบะปััะตะฝะธั
5. **ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะฟะพะดะบะปััะตะฝะธะต** ะฟัะธ ะฟะพัะตัะต ัะฒัะทะธ
6. **ะะพััะตะบัะฝะพะต ะทะฐะบัััะธะต ัะพะตะดะธะฝะตะฝะธะน** ะฟัะธ ัะดะฐะปะตะฝะธะธ ะฟัะธะฝัะตัะฐ ะธะปะธ ะฒััะพะดะต

### ๐ ะะทะผะตะฝัะฝะฝัะต ัะฐะนะปั:

- โ๏ธ `src/main.js` (+~100 ัััะพะบ) - MQTT ะผะตะฝะตะดะถะตั ะธ IPC ะพะฑัะฐะฑะพััะธะบะธ
- โ๏ธ `src/preload.js` (+6 ัััะพะบ) - API ะดะปั Bambu ะฟะพะดะบะปััะตะฝะธะน
- โ๏ธ `src/renderer.js` (+~80 ัััะพะบ) - ัะตะฐะปัะฝะพะต ะฟะพะดะบะปััะตะฝะธะต ะธ ะพะฑัะฐะฑะพัะบะฐ ะพะฑะฝะพะฒะปะตะฝะธะน
- โ๏ธ `package.json` - ะฒะตััะธั 1.5.9.1 โ 1.5.10
- โ๏ธ `changelog.md` - ะดะพะฑะฐะฒะปะตะฝะฐ ะทะฐะฟะธัั ะพ v1.5.10

### ๐ฌ ะขะตัะฝะธัะตัะบะฐั ะฐััะธัะตะบัััะฐ:

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Renderer Process                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ testBambuLabConnection()                         โ  โ
โ  โ   โ ะฒัะทัะฒะฐะตั                                     โ  โ
โ  โ window.electronAPI.testBambuConnection()         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ IPC invoke
                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     Main Process                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ipcMain.handle('test-bambu-connection')          โ  โ
โ  โ   โ ะฒัะทัะฒะฐะตั                                     โ  โ
โ  โ testBambuConnection(printerData)                 โ  โ
โ  โ   โ ัะพะทะดะฐัั                                      โ  โ
โ  โ BambuLabAdapter instance                         โ  โ
โ  โ   โ ะฒัะทัะฒะฐะตั                                     โ  โ
โ  โ adapter.testConnection()                         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ MQTT/MQTTS
                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Bambu Lab Printer (port 8883)              โ
โ                     MQTT Broker                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

Real-time updates flow:
Printer โ MQTT โ Adapter โ Main Process โ 
    IPC send โ Renderer โ handleBambuPrinterUpdate()
```

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะะปั ัะตะฐะปัะฝะพะณะพ ัะตััะธัะพะฒะฐะฝะธั ััะตะฑัะตััั:

1. โ ะคะธะทะธัะตัะบะธะน ะฟัะธะฝัะตั Bambu Lab (X1, X1C, P1P, P1S, A1, A1 Mini)
2. โ ะะบะปััะตะฝะฝัะน Developer Mode / LAN Mode ะฝะฐ ะฟัะธะฝัะตัะต
3. โ Access Code (8 ัะธัั)
4. โ Serial Number ะฟัะธะฝัะตัะฐ
5. โ ะัะธะฝัะตั ะธ ะะ ะฒ ะพะดะฝะพะน ะปะพะบะฐะปัะฝะพะน ัะตัะธ

### ะจะฐะณะธ ัะตััะธัะพะฒะฐะฝะธั:

1. ะะฐะฟัััะธัั ะฟัะธะปะพะถะตะฝะธะต
2. ะะฐะถะฐัั "Add Printer"
3. ะัะฑัะฐัั ัะธะฟ "Bambu Lab"
4. ะะฐะฟะพะปะฝะธัั:
   - Name: ะปัะฑะพะต ะธะผั
   - IP: IP ะฟัะธะฝัะตัะฐ ะฒ ะปะพะบะฐะปัะฝะพะน ัะตัะธ
   - Access Code: 8-ะทะฝะฐัะฝัะน ะบะพะด
   - Serial Number: ัะตัะธะนะฝัะน ะฝะพะผะตั ะฟัะธะฝัะตัะฐ
5. ะะฐะถะฐัั "Add"
6. ะะฐะฑะปัะดะฐัั ะฒ ะบะพะฝัะพะปะธ:
   - `๐ Testing connection...`
   - `โน๏ธ Connecting via MQTT...`
   - `โ Printer name - MQTT success (MQTTS)` ะธะปะธ `(MQTT)`

### ะะถะธะดะฐะตะผัะต ัะตะทัะปััะฐัั:

- โ ะกัะฐััั ะฟัะธะฝัะตัะฐ: "ready" (ะตัะปะธ ะฝะต ะฟะตัะฐัะฐะตั) ะธะปะธ "printing" (ะตัะปะธ ะฟะตัะฐัะฐะตั)
- โ Connection Type: "MQTT (MQTTS)" ะธะปะธ "MQTT (MQTT)"
- โ ะขะตะผะฟะตัะฐัััั ะพัะพะฑัะฐะถะฐัััั (ัะบััััะดะตั, ััะพะป, ะบะฐะผะตัะฐ)
- โ ะัะปะธ ะฟะตัะฐัะฐะตั - ะพัะพะฑัะฐะถะฐะตััั ะฟัะพะณัะตัั ะธ ะธะผั ัะฐะนะปะฐ
- โ ะะฐะฝะฝัะต ะพะฑะฝะพะฒะปััััั ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ

### ะัะธะผะตัะฐะฝะธั:

โ๏ธ ะะพัะบะพะปัะบั ั ะผะตะฝั ะฝะตั ัะธะทะธัะตัะบะพะณะพ ะดะพัััะฟะฐ ะบ ะฟัะธะฝัะตัั Bambu Lab, **ัะตะฐะปัะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต ะฝะฐ ะถะตะปะตะทะต ะฝะต ะฒัะฟะพะปะฝัะปะพัั**.

ะะดะฝะฐะบะพ:
- โ ะะพะด ะฟัะพะฒะตัะตะฝ ะฝะฐ ัะธะฝัะฐะบัะธัะตัะบะธะต ะพัะธะฑะบะธ (ะปะธะฝัะตั)
- โ ะััะธัะตะบัััะฐ ัะพะพัะฒะตัััะฒัะตั ะปัััะธะผ ะฟัะฐะบัะธะบะฐะผ Electron
- โ ะัะฟะพะปัะทัะตััั ะฟัะพะฒะตัะตะฝะฝะฐั ะฑะธะฑะปะธะพัะตะบะฐ `mqtt@^5.3.5`
- โ ะะดะฐะฟัะตั `bambu-printer-adapter.js` ะฑัะป ะฟัะฐะฒะธะปัะฝะพ ะฝะฐะฟะธัะฐะฝ ะธะทะฝะฐัะฐะปัะฝะพ
- โ ะะฝัะตะณัะฐัะธั ัะปะตะดัะตั ะฟะฐััะตัะฝั, ะธัะฟะพะปัะทัะตะผะพะผั ะดะปั Klipper ะฟัะธะฝัะตัะพะฒ

## ๐ ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะผะฐัะตัะธะฐะปั

- ะะพะบัะผะตะฝัะฐัะธั: `BAMBU_LAB_SETUP.md`, `BAMBU_LAB_SETUP_RU.md`
- Troubleshooting: `BAMBU_TROUBLESHOOTING_EN.md`, `BAMBU_TROUBLESHOOTING_RU.md`
- Changelog: `changelog.md`

## ๐ ะะฐะบะปััะตะฝะธะต

**ะัะพะฑะปะตะผะฐ ัะตัะตะฝะฐ ะฝะฐ ััะพะฒะฝะต ะฐััะธัะตะบัััั.**

ะขะตะฟะตัั ะฟัะธะปะพะถะตะฝะธะต ะธะผะตะตั **ะฟะพะปะฝัั ะธะฝััะฐััััะบัััั** ะดะปั ัะฐะฑะพัั ั ะฟัะธะฝัะตัะฐะผะธ Bambu Lab:
- โ MQTT ะผะตะฝะตะดะถะตั
- โ IPC ะบะพะผะผัะฝะธะบะฐัะธั
- โ Real-time ะพะฑะฝะพะฒะปะตะฝะธั
- โ ะะพััะตะบัะฝะฐั ะพัะธััะบะฐ ัะตััััะพะฒ
- โ ะะพะดะดะตัะถะบะฐ ะพะฑะพะธั ะฟัะพัะพะบะพะปะพะฒ (MQTT/MQTTS)
- โ ะะฒัะพะผะฐัะธัะตัะบะพะต ะฟะตัะตะฟะพะดะบะปััะตะฝะธะต

ะะพะปัะทะพะฒะฐัะตะปะธ ัะตะฟะตัั **ะกะะะะฃะข ะฟะพะดะบะปััะฐัั** ัะฒะพะธ ะฟัะธะฝัะตัั Bambu Lab ะธ ะฟะพะปััะฐัั ะฐะบััะฐะปัะฝัะต ะดะฐะฝะฝัะต ะฒ ัะตะฐะปัะฝะพะผ ะฒัะตะผะตะฝะธ! ๐๐จ๏ธ

---

**ะะฐัะฐ:** 09.10.2025  
**ะะตััะธั:** 1.5.10  
**ะกัะฐััั:** โ ะะพัะพะฒะพ ะบ ัะตััะธัะพะฒะฐะฝะธั ะฝะฐ ัะตะฐะปัะฝะพะผ ะพะฑะพััะดะพะฒะฐะฝะธะธ

