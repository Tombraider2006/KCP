<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    
    <!-- TinyMCE -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</head>
<body class="admin-page">
    <header class="admin-header">
        <div class="admin-header-content">
            <div class="admin-logo">üîß –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
            <nav class="admin-nav">
                <ul>
                    <li><a href="/admin/dashboard">üìä –î–∞—à–±–æ—Ä–¥</a></li>
                    <li><a href="/admin/news" class="active">üì∞ –ù–æ–≤–æ—Å—Ç–∏</a></li>
                    <li><a href="/admin/telemetry.html">üìä –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è</a></li>
                    <li><a href="/admin/files.html">üìÅ –§–∞–π–ª—ã</a></li>
                    <li><a href="/admin/settings">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</a></li>
                    <li><a href="/admin/logout">üö™ –í—ã—Ö–æ–¥</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="admin-container">
        <div class="admin-card">
            <h2 id="page-title">üìù –ù–æ–≤–∞—è –Ω–æ–≤–æ—Å—Ç—å</h2>
            
            <div id="alert-container"></div>
            
            <form id="news-form">
                <input type="hidden" id="news-id" name="id">
                
                <div class="form-group">
                    <label class="form-label" for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
                    <input 
                        type="text" 
                        id="title" 
                        name="title" 
                        class="form-input" 
                        required
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="slug">URL (slug) *</label>
                    <input 
                        type="text" 
                        id="slug" 
                        name="slug" 
                        class="form-input" 
                        required
                        placeholder="url-dlya-novosti"
                        pattern="[a-z0-9-]+"
                    >
                    <span class="form-hint">
                        –¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã. –ü—Ä–∏–º–µ—Ä: new-version-released
                    </span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="excerpt">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea 
                        id="excerpt" 
                        name="excerpt" 
                        class="form-textarea"
                        placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ –Ω–æ–≤–æ—Å—Ç–µ–π"
                        rows="3"
                    ></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="content">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ *</label>
                    <textarea 
                        id="content" 
                        name="content" 
                        required
                    ></textarea>
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="published" name="published">
                    <label for="published">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É</label>
                </div>
                
                <div class="btn-group" style="margin-top: 30px;">
                    <button type="submit" class="btn-admin btn-admin-success">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                    </button>
                    <button type="button" class="btn-admin btn-admin-primary" onclick="previewNews()">
                        üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                    </button>
                    <button type="button" class="btn-admin btn-admin-danger" onclick="deleteNews()" id="delete-btn" style="display: none;">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                    </button>
                    <a href="/admin/dashboard" class="btn-admin btn-admin-secondary">
                        ‚Üê –û—Ç–º–µ–Ω–∞
                    </a>
                </div>
            </form>
        </div>

        <!-- All News List -->
        <div class="admin-card">
            <h2>üì∞ –í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏</h2>
            <div class="btn-group" style="margin-bottom: 20px;">
                <a href="/admin/news/new" class="btn-admin btn-admin-success">
                    ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å
                </a>
            </div>
            <div id="news-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let editor;
        let currentNewsId = null;
        
        // Initialize TinyMCE
        tinymce.init({
            selector: '#content',
            height: 500,
            menubar: true,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount'
            ],
            toolbar: 'undo redo | blocks | ' +
                'bold italic forecolor | alignleft aligncenter ' +
                'alignright alignjustify | bullist numlist outdent indent | ' +
                'removeformat | help',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif; font-size: 16px; line-height: 1.6; color: #e0e6ed; background: #0a1628; }',
            skin: 'oxide-dark',
            content_css: 'dark',
            setup: function(ed) {
                editor = ed;
            }
        });
        
        // Auto-generate slug from title
        document.getElementById('title').addEventListener('input', function(e) {
            const slugInput = document.getElementById('slug');
            if (!slugInput.value || currentNewsId === null) {
                const slug = e.target.value
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
                slugInput.value = slug;
            }
        });
        
        // Check if editing existing news
        const pathParts = window.location.pathname.split('/');
        if (pathParts[pathParts.length - 2] === 'edit') {
            currentNewsId = pathParts[pathParts.length - 1];
            loadNewsForEdit(currentNewsId);
        }
        
        // Load news for editing
        async function loadNewsForEdit(id) {
            try {
                const response = await fetch(`/api/news/${id}`);
                if (!response.ok) throw new Error('Failed to load news');
                
                const news = await response.json();
                
                document.getElementById('page-title').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å';
                document.getElementById('news-id').value = news.id;
                document.getElementById('title').value = news.title;
                document.getElementById('slug').value = news.slug;
                document.getElementById('excerpt').value = news.excerpt || '';
                document.getElementById('published').checked = news.published === 1;
                document.getElementById('delete-btn').style.display = 'inline-block';
                
                // Wait for TinyMCE to initialize
                const checkEditor = setInterval(() => {
                    if (editor) {
                        editor.setContent(news.content);
                        clearInterval(checkEditor);
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error loading news:', error);
                showAlert('error', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–∏');
            }
        }
        
        // Submit form
        document.getElementById('news-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                slug: document.getElementById('slug').value,
                excerpt: document.getElementById('excerpt').value,
                content: editor.getContent(),
                published: document.getElementById('published').checked
            };
            
            try {
                const url = currentNewsId ? `/api/news/${currentNewsId}` : '/api/news';
                const method = currentNewsId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('success', currentNewsId ? '–ù–æ–≤–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–ù–æ–≤–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞!');
                    
                    if (!currentNewsId) {
                        setTimeout(() => {
                            window.location.href = `/admin/news/edit/${data.id}`;
                        }, 1500);
                    } else {
                        loadNewsList();
                    }
                } else {
                    showAlert('error', data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Error saving news:', error);
                showAlert('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        });
        
        // Delete news
        async function deleteNews() {
            if (!currentNewsId) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å?')) return;
            
            try {
                const response = await fetch(`/api/news/${currentNewsId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('success', '–ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞!');
                    setTimeout(() => {
                        window.location.href = '/admin/news/new';
                    }, 1500);
                } else {
                    showAlert('error', '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('Error deleting news:', error);
                showAlert('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }
        
        // Preview news
        function previewNews() {
            const title = document.getElementById('title').value;
            const content = editor.getContent();
            
            const previewWindow = window.open('', 'Preview', 'width=800,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä - ${title}</title>
                    <link rel="stylesheet" href="/css/style.css">
                </head>
                <body>
                    <div class="container">
                        <div class="card">
                            <h1>${title}</h1>
                            <div class="news-content">
                                ${content}
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `);
            previewWindow.document.close();
        }
        
        // Show alert
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${icon} ${message}
                </div>
            `;
            
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
        
        // Load news list
        async function loadNewsList() {
            try {
                const response = await fetch('/api/news');
                const news = await response.json();
                
                const listContainer = document.getElementById('news-list');
                
                if (news.length === 0) {
                    listContainer.innerHTML = '<p style="color: var(--admin-text-secondary); text-align: center; padding: 40px;">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }
                
                listContainer.innerHTML = news.map(item => {
                    const date = new Date(item.created_at).toLocaleDateString('ru-RU');
                    const badge = item.published 
                        ? '<span class="badge badge-published">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</span>'
                        : '<span class="badge badge-draft">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>';
                    
                    return `
                        <div class="news-list-item">
                            <div>
                                <div class="news-list-title">${item.title}${badge}</div>
                                <div class="news-list-meta">üìÖ ${date} | Slug: ${item.slug}</div>
                            </div>
                            <div class="news-list-actions">
                                <a href="/admin/news/edit/${item.id}" class="btn-admin btn-admin-primary" style="padding: 8px 16px; font-size: 0.9em;">
                                    ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </a>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading news list:', error);
            }
        }
        
        // Load news list on page load
        document.addEventListener('DOMContentLoaded', loadNewsList);
    </script>
</body>
</html>

