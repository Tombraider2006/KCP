#!/bin/bash

##############################################################################
# ะกะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ัััะฐะฝะพะฒะบะธ ัะฐะนัะฐ 3D Printer Control Panel ะฝะฐ ัะตัะฒะตั
# ะะตััะธั: 1.0
# ะะฒัะพั: Tom Tomich
##############################################################################

set -e  # ะััะฐะฝะฐะฒะปะธะฒะฐัััั ะฟัะธ ะพัะธะฑะบะฐั

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                                                           โ"
echo "โ   ๐จ๏ธ  3D Printer Control Panel - Website Installer      โ"
echo "โ                                                           โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธะธ ะดะปั ะฒัะฒะพะดะฐ
info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# ะัะพะฒะตัะบะฐ ััะพ ัะบัะธะฟั ะทะฐะฟััะตะฝ ะธะท ะฟะฐะฟะบะธ website
if [ ! -f "package.json" ] || [ ! -f "server.js" ]; then
    error "ะะฐะฟัััะธัะต ััะพั ัะบัะธะฟั ะธะท ะฟะฐะฟะบะธ website/"
fi

info "ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
echo ""

# ============================================================================
# ะจะะ 1: ะัะพะฒะตัะบะฐ Node.js ะธ npm
# ============================================================================

info "ะจะฐะณ 1/7: ะัะพะฒะตัะบะฐ Node.js ะธ npm..."

if ! command -v node &> /dev/null; then
    error "Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ! ะฃััะฐะฝะพะฒะธัะต Node.js 14+ ะธ ะทะฐะฟัััะธัะต ัะบัะธะฟั ัะฝะพะฒะฐ."
fi

if ! command -v npm &> /dev/null; then
    error "npm ะฝะต ัััะฐะฝะพะฒะปะตะฝ! ะฃััะฐะฝะพะฒะธัะต npm ะธ ะทะฐะฟัััะธัะต ัะบัะธะฟั ัะฝะพะฒะฐ."
fi

NODE_VERSION=$(node -v)
success "Node.js ัััะฐะฝะพะฒะปะตะฝ: $NODE_VERSION"
echo ""

# ============================================================================
# ะจะะ 2: ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ
# ============================================================================

info "ะจะฐะณ 2/7: ะัะพะฒะตัะบะฐ ะฟะพััะพะฒ..."

# ะัะพะฒะตััะตะผ ััะพ ะฟะพัั 3000 ะทะฐะฝัั (telemetry ัะตัะฒะตั)
if netstat -tuln 2>/dev/null | grep -q ":3000 "; then
    success "ะะพัั 3000 ะทะฐะฝัั (telemetry ัะตัะฒะตั ัะฐะฑะพัะฐะตั) โ"
elif ss -tuln 2>/dev/null | grep -q ":3000 "; then
    success "ะะพัั 3000 ะทะฐะฝัั (telemetry ัะตัะฒะตั ัะฐะฑะพัะฐะตั) โ"
else
    warning "ะะพัั 3000 ัะฒะพะฑะพะดะตะฝ. ะฃะฑะตะดะธัะตัั, ััะพ telemetry ัะตัะฒะตั ะทะฐะฟััะตะฝ!"
fi

# ะัะพะฒะตััะตะผ ััะพ ะฟะพัั 8080 ัะฒะพะฑะพะดะตะฝ
if netstat -tuln 2>/dev/null | grep -q ":8080 "; then
    error "ะะพัั 8080 ัะถะต ะทะฐะฝัั! ะะทะผะตะฝะธัะต PORT ะฒ .env ะธะปะธ ะพัะฒะพะฑะพะดะธัะต ะฟะพัั."
elif ss -tuln 2>/dev/null | grep -q ":8080 "; then
    error "ะะพัั 8080 ัะถะต ะทะฐะฝัั! ะะทะผะตะฝะธัะต PORT ะฒ .env ะธะปะธ ะพัะฒะพะฑะพะดะธัะต ะฟะพัั."
else
    success "ะะพัั 8080 ัะฒะพะฑะพะดะตะฝ โ"
fi

echo ""

# ============================================================================
# ะจะะ 3: ะกะพะทะดะฐะฝะธะต .env ะบะพะฝัะธะณััะฐัะธะธ
# ============================================================================

info "ะจะฐะณ 3/7: ะกะพะทะดะฐะฝะธะต ะบะพะฝัะธะณััะฐัะธะธ..."

if [ ! -f ".env" ]; then
    info "ะกะพะทะดะฐั .env ัะฐะนะป ะธะท ัะฐะฑะปะพะฝะฐ..."
    
    # ะะตะฝะตัะธััะตะผ ัะปััะฐะนะฝัะน SESSION_SECRET
    SESSION_SECRET=$(openssl rand -base64 32 2>/dev/null || cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1)
    
    # ะกะพะทะดะฐะตะผ .env
    cat > .env << EOF
# Server Configuration
PORT=8080
NODE_ENV=production

# Session Secret (ะฐะฒัะพะผะฐัะธัะตัะบะธ ัะณะตะฝะตัะธัะพะฒะฐะฝ)
SESSION_SECRET=$SESSION_SECRET

# Admin Credentials (ะะะฏะะะขะะะฌะะ ะะะะะะะขะ!)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=changeme123

# GitHub Configuration
GITHUB_TOKEN=
GITHUB_OWNER=Tombraider2006
GITHUB_REPO=KCP

# Website Configuration
SITE_URL=https://tomich.fun
SITE_NAME=3D Printer Control Panel

# Database Configuration
DATABASE_PATH=./website.db
EOF
    
    success ".env ัะฐะนะป ัะพะทะดะฐะฝ!"
    warning "โ๏ธ  ะะะะะ: ะะทะผะตะฝะธัะต ADMIN_PASSWORD ะฒ .env ัะฐะนะปะต!"
    echo ""
    
    read -p "ะะฐะถะผะธัะต Enter ะดะปั ะฟัะพะดะพะปะถะตะฝะธั ะธะปะธ Ctrl+C ะดะปั ัะตะดะฐะบัะธัะพะฒะฐะฝะธั .env..."
else
    success ".env ัะฐะนะป ัะถะต ัััะตััะฒัะตั"
fi

echo ""

# ============================================================================
# ะจะะ 4: ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
# ============================================================================

info "ะจะฐะณ 4/7: ะฃััะฐะฝะพะฒะบะฐ npm ะทะฐะฒะธัะธะผะพััะตะน..."

if [ ! -d "node_modules" ]; then
    info "ะฃััะฐะฝะฐะฒะปะธะฒะฐั ะฟะฐะบะตัั..."
    npm install --production
    success "ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั!"
else
    info "ะะฑะฝะพะฒะปัั ะทะฐะฒะธัะธะผะพััะธ..."
    npm install --production
    success "ะะฐะฒะธัะธะผะพััะธ ะพะฑะฝะพะฒะปะตะฝั!"
fi

echo ""

# ============================================================================
# ะจะะ 5: ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั
# ============================================================================

info "ะจะฐะณ 5/7: ะัะพะฒะตัะบะฐ ะฑะฐะทั ะดะฐะฝะฝัั..."

if [ -f "website.db" ]; then
    warning "ะะฐะทะฐ ะดะฐะฝะฝัั website.db ัะถะต ัััะตััะฒัะตั"
    read -p "ะะตัะตัะพะทะดะฐัั ะฑะฐะทั ะดะฐะฝะฝัั? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        info "ะกะพะทะดะฐั ัะตะทะตัะฒะฝัั ะบะพะฟะธั..."
        mv website.db "website.db.backup.$(date +%Y%m%d_%H%M%S)"
        success "ะกัะฐัะฐั ะฑะฐะทะฐ ัะพััะฐะฝะตะฝะฐ ะบะฐะบ backup"
    fi
else
    success "ะะฐะทะฐ ะดะฐะฝะฝัั ะฑัะดะตั ัะพะทะดะฐะฝะฐ ะฟัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต"
fi

echo ""

# ============================================================================
# ะจะะ 6: ะฃััะฐะฝะพะฒะบะฐ PM2 ะธ ะทะฐะฟััะบ ัะตัะฒะตัะฐ
# ============================================================================

info "ะจะฐะณ 6/7: ะะฐัััะพะนะบะฐ PM2 ะธ ะทะฐะฟััะบ ัะตัะฒะตัะฐ..."

if ! command -v pm2 &> /dev/null; then
    warning "PM2 ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะฐะฒะปะธะฒะฐั..."
    if command -v sudo &> /dev/null; then
        sudo npm install -g pm2
    else
        npm install -g pm2
    fi
    success "PM2 ัััะฐะฝะพะฒะปะตะฝ!"
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะน ะฟัะพัะตัั ะตัะปะธ ะตััั
if pm2 describe 3dpc-website &> /dev/null; then
    info "ะััะฐะฝะฐะฒะปะธะฒะฐั ััะฐััะน ะฟัะพัะตัั..."
    pm2 delete 3dpc-website
fi

# ะะฐะฟััะบะฐะตะผ ะฝะพะฒัะน ะฟัะพัะตัั
info "ะะฐะฟััะบะฐั ัะตัะฒะตั..."
pm2 start server.js --name "3dpc-website" --time

# ะกะพััะฐะฝัะตะผ ะบะพะฝัะธะณััะฐัะธั
pm2 save

success "ะกะตัะฒะตั ะทะฐะฟััะตะฝ!"
echo ""

# ะัะพะฒะตััะตะผ ััะฐััั
pm2 list

echo ""

# ============================================================================
# ะจะะ 7: ะะฐัััะพะนะบะฐ ะฐะฒัะพะทะฐะฟััะบะฐ
# ============================================================================

info "ะจะฐะณ 7/7: ะะฐัััะพะนะบะฐ ะฐะฒัะพะทะฐะฟััะบะฐ ะฟัะธ ะฟะตัะตะทะฐะณััะทะบะต..."

read -p "ะะฐัััะพะธัั ะฐะฒัะพะทะฐะฟััะบ ะฟัะธ ะฟะตัะตะทะฐะณััะทะบะต ัะตัะฒะตัะฐ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    info "ะะตะฝะตัะธััั ะบะพะผะฐะฝะดั ะฝะฐัััะพะนะบะธ ะฐะฒัะพะทะฐะฟััะบะฐ..."
    
    # ะะพะปััะฐะตะผ ะบะพะผะฐะฝะดั ะพั pm2 startup
    STARTUP_CMD=$(pm2 startup | grep "sudo env PATH" || pm2 startup | grep "sudo")
    
    if [ -z "$STARTUP_CMD" ]; then
        warning "ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ะบะพะผะฐะฝะดั ะฐะฒัะพะทะฐะฟััะบะฐ."
        info "ะัะฟะพะปะฝะธัะต ะฒัััะฝัั ะฟะพัะปะต ัััะฐะฝะพะฒะบะธ:"
        echo "   pm2 startup"
        echo "   # ะะฐัะตะผ ะฒัะฟะพะปะฝะธัะต ะบะพะผะฐะฝะดั, ะบะพัะพััั ะฟะพะบะฐะถะตั PM2"
        echo "   pm2 save"
    else
        info "ะะพะผะฐะฝะดะฐ ะฐะฒัะพะทะฐะฟััะบะฐ:"
        echo "   $STARTUP_CMD"
        echo ""
        
        if command -v sudo &> /dev/null; then
            read -p "ะัะฟะพะปะฝะธัั ะบะพะผะฐะฝะดั? (ััะตะฑัะตััั sudo) (Y/n): " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Nn]$ ]]; then
                eval "$STARTUP_CMD"
                pm2 save
                success "ะะฒัะพะทะฐะฟััะบ ะฝะฐัััะพะตะฝ!"
            else
                info "ะัะฟะพะปะฝะธัะต ะบะพะผะฐะฝะดั ะฒัััะฝัั ะดะปั ะฝะฐัััะพะนะบะธ ะฐะฒัะพะทะฐะฟััะบะฐ"
            fi
        else
            warning "sudo ะฝะต ะดะพัััะฟะตะฝ. ะัะฟะพะปะฝะธัะต ะบะพะผะฐะฝะดั ะฒัััะฝัั:"
            echo "$STARTUP_CMD"
            info "ะะพัะปะต ะฒัะฟะพะปะฝะตะฝะธั ะบะพะผะฐะฝะดั ะทะฐะฟัััะธัะต: pm2 save"
        fi
    fi
else
    info "ะะฒัะพะทะฐะฟััะบ ะฟัะพะฟััะตะฝ"
    info "ะะปั ะฝะฐัััะพะนะบะธ ะฟะพะทะถะต ะฒัะฟะพะปะฝะธัะต: pm2 startup && pm2 save"
fi

echo ""

# ============================================================================
# ะะขะะะะะะฏ ะะะคะะะะะฆะะฏ
# ============================================================================

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ                                                           โ"
echo "โ   โ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ!                        โ"
echo "โ                                                           โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

success "ะกะตัะฒะตั ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั 8080"
echo ""

info "๐ URL ัะฐะนัะฐ:"
echo "   โข ะะพะบะฐะปัะฝะพ:       http://localhost:8080"
echo "   โข ะะฝะตัะฝะธะน ะฐะดัะตั:  https://tomich.fun (ะฟะพัะปะต ะฝะฐัััะพะนะบะธ Nginx)"
echo ""

info "๐ ะะดะผะธะฝ-ะฟะฐะฝะตะปั:"
echo "   โข URL:      http://localhost:8080/admin/login"
echo "   โข ะะพะณะธะฝ:    admin (ะธะปะธ ะธะท .env)"
echo "   โข ะะฐัะพะปั:   ะธะท ัะฐะนะปะฐ .env"
echo ""

warning "โ๏ธ  ะะะฏะะะขะะะฌะะ ะกะะะะะะขะ:"
echo "   1. ะะทะผะตะฝะธัะต ADMIN_PASSWORD ะฒ .env ัะฐะนะปะต"
echo "   2. ะะตัะตะทะฐะฟัััะธัะต ัะตัะฒะตั: pm2 restart 3dpc-website"
echo "   3. ะะฐัััะพะนัะต Nginx ะดะปั ะดะพัััะฟะฐ ัะตัะตะท ะดะพะผะตะฝ"
echo ""

info "๐ ะฃะฟัะฐะฒะปะตะฝะธะต ัะตัะฒะตัะพะผ:"
echo "   โข ะะพะณะธ:        pm2 logs 3dpc-website"
echo "   โข ะกัะฐััั:      pm2 list"
echo "   โข ะะตัะตะทะฐะฟััะบ:  pm2 restart 3dpc-website"
echo "   โข ะััะฐะฝะพะฒะบะฐ:   pm2 stop 3dpc-website"
echo "   โข ะะพะฝะธัะพัะธะฝะณ:  pm2 monit"
echo ""

info "๐ ะคะฐะนะปั:"
echo "   โข ะะฐะทะฐ ะดะฐะฝะฝัั: $(pwd)/website.db"
echo "   โข ะะพะฝัะธะณััะฐัะธั: $(pwd)/.env"
echo "   โข ะะพะณะธ PM2: ~/.pm2/logs/"
echo ""

info "๐ง ะกะปะตะดัััะธะต ัะฐะณะธ:"
echo "   1. ะะพะฑะฐะฒััะต ัะบัะธะฝัะพัั ะฒ: $(pwd)/public/screenshots/"
echo "   2. ะกะพะทะดะฐะนัะต ะฟะตัะฒัั ะฝะพะฒะพััั ัะตัะตะท ะฐะดะผะธะฝ-ะฟะฐะฝะตะปั"
echo "   3. ะะฐัััะพะนัะต GitHub Token ะดะปั ะฟัะธะฒะฐัะฝะพะณะพ ัะตะฟะพะทะธัะพัะธั"
echo ""

# ะะพะบะฐะทัะฒะฐะตะผ ะปะพะณะธ
read -p "ะะพะบะฐะทะฐัั ะปะพะณะธ ัะตัะฒะตัะฐ? (Y/n): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    pm2 logs 3dpc-website --lines 20
fi

echo ""
success "ะะพัะพะฒะพ! ะกะฐะนั ัะฐะฑะพัะฐะตั! ๐"
echo ""

