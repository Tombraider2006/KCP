<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http:; script-src 'self' 'unsafe-inline' 'unsafe-eval';">
    <title>Tom Tomich's 3D Printer Control Panel</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Shift Info Bar -->
    <div id="shiftInfoBar" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; justify-content: space-between; align-items: center; z-index: 10000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
        <div style="display: flex; align-items: center; gap: 20px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 20px;">👤</span>
                <div>
                    <div style="font-weight: 600; font-size: 14px;" id="shiftUsername">Загрузка...</div>
                    <div style="font-size: 11px; opacity: 0.9;" id="shiftDuration">--</div>
                </div>
            </div>
            <button id="btnManageUsers" style="display: none; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease;" onclick="openUserManagement()">
                👥 Управление пользователями
            </button>
        </div>
        <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 15px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.3s ease;">
            🚪 Выход
        </button>
    </div>

    <div class="container" style="margin-top: 60px;">
        <header>
            <div class="header-main">
                <h1>🖨️ Tom Tomich's 3D Printer Control Panel</h1>
                <div class="app-version" id="appVersion">v—</div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="openAddPrinterModal()" data-i18n="add_printer">➕ Add Printer</button>
                <button class="btn btn-secondary" onclick="startNetworkScan()">🔍 <span id="scanNetworkBtnText">Scan Network</span></button>
                <button class="btn btn-secondary" onclick="testAllConnections()">🔗 Test All Connections</button>
                <button class="btn btn-telegram" onclick="openTelegramSettingsModal()">🤖 Telegram</button>
                <button class="btn btn-secondary" onclick="openAnalyticsModal()">📈 <span id="analyticsBtnText">Analytics</span></button>
                <div class="interval-selector">
                    <label>Polling interval: </label>
                    <select id="pollingInterval" onchange="updatePollingInterval(this.value)">
                        <option value="10000">10 sec</option>
                        <option value="15000">15 sec</option>
                        <option value="20000">20 sec</option>
                        <option value="30000" selected>30 sec</option>
                        <option value="45000">45 sec</option>
                        <option value="60000">60 sec</option>
                        <option value="75000">75 sec</option>
                        <option value="90000">90 sec</option>
                    </select>
                </div>
            </div>
            <div class="printers-counter">
                <span class="counter printing">🖨️ <span id="count-printing">0</span></span>
                <span class="counter offline">🔌 <span id="count-offline">0</span></span>
                <span class="counter ready">✅ <span id="count-ready">0</span></span>
                <span class="counter complete">🏁 <span id="count-complete">0</span></span>
                <span class="counter paused">⏸️ <span id="count-paused">0</span></span>
                <span class="counter error">🚫 <span id="count-error">0</span></span>
            </div>
        </header>

        <main>
            <section class="card">
                <h2>📊 Printer Status</h2>
                <div id="printersContainer" class="printers-container"></div>
            </section>

            <section class="card">
                <h2>📋 Event Log</h2>
                <div class="console">
                    <div id="messageConsole" class="console-content"></div>
                    <div class="console-controls">
                        <button class="btn btn-small" onclick="clearConsole()">🗑️ Clear</button>
                        <button class="btn btn-small" onclick="exportLogs()">📥 Export</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Printer Modal -->
    <div id="addPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="add_printer">➕ Add Printer</h3>
                <span class="close" onclick="closeAddPrinterModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="printerType" data-i18n="printer_type">Printer type:</label>
                    <select id="printerType" onchange="togglePrinterTypeFields('add')">
                        <option value="klipper" data-i18n="klipper_moonraker">Klipper (Moonraker)</option>
                        <option value="bambu" data-i18n="bambu_lab">Bambu Lab</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="printerName" data-i18n="printer_name">Printer name:</label>
                    <input type="text" id="printerName" placeholder="My Printer">
                </div>
                <div class="form-group">
                    <label for="printerIP" data-i18n="ip_address">IP address:</label>
                    <input type="text" id="printerIP" placeholder="192.168.1.100">
                </div>
                
                <!-- Klipper specific fields -->
                <div id="klipperFields" class="printer-type-fields">
                    <div class="form-group">
                        <label for="webInterfacePort" data-i18n="web_interface_port_optional">Web interface port (optional):</label>
                        <input type="number" id="webInterfacePort" placeholder="80">
                    </div>
                </div>
                
                <!-- Bambu Lab specific fields -->
                <div id="bambuFields" class="printer-type-fields" style="display: none;">
                    <div class="form-group">
                        <label for="accessCode" data-i18n="access_code">Access Code:</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="password" id="accessCode" placeholder="12345678" style="flex: 1;">
                            <button type="button" class="toggle-visibility" data-target="accessCode" title="Show/Hide">
                                👁️
                            </button>
                        </div>
                        <small data-i18n="access_code_hint">Get from printer settings → Network → Access Code</small>
                    </div>
                    <div class="form-group">
                        <label for="serialNumber" data-i18n="serial_number">Serial Number:</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="password" id="serialNumber" placeholder="01P00A123456789" style="flex: 1;">
                            <button type="button" class="toggle-visibility" data-target="serialNumber" title="Show/Hide">
                                👁️
                            </button>
                        </div>
                        <small data-i18n="serial_number_hint">Find on printer label or in settings</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="bambuDevMode" checked>
                            <span data-i18n="dev_mode_enabled">Developer Mode enabled on printer</span>
                        </label>
                        <small style="display: block; margin-top: 5px;" data-i18n="dev_mode_warning">⚠️ Developer mode must be enabled in printer settings</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="addPrinter()" data-i18n="add">Add</button>
                    <button class="btn" onclick="closeAddPrinterModal()" data-i18n="cancel">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Printer Modal -->
    <div id="editPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>✏️ Edit Printer</h3>
                <span class="close" onclick="closeEditPrinterModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPrinterId">
                <div class="form-group">
                    <label for="editPrinterType">Printer type:</label>
                    <select id="editPrinterType" onchange="togglePrinterTypeFields('edit')">
                        <option value="klipper">Klipper (Moonraker)</option>
                        <option value="bambu">Bambu Lab</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPrinterName">Printer name:</label>
                    <input type="text" id="editPrinterName">
                </div>
                <div class="form-group">
                    <label for="editPrinterIP">IP address:</label>
                    <input type="text" id="editPrinterIP" placeholder="192.168.1.100">
                </div>
                
                <!-- Klipper specific fields -->
                <div id="editKlipperFields" class="printer-type-fields">
                    <div class="form-group">
                        <label for="editPrinterPort">Moonraker port:</label>
                        <input type="number" id="editPrinterPort" placeholder="7125">
                    </div>
                    <div class="form-group">
                        <label for="editWebInterfacePort">Web interface port (optional):</label>
                        <input type="number" id="editWebInterfacePort" placeholder="80">
                    </div>
                </div>
                
                <!-- Bambu Lab specific fields -->
                <div id="editBambuFields" class="printer-type-fields" style="display: none;">
                    <div class="form-group">
                        <label for="editAccessCode" data-i18n="access_code">Access Code:</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="password" id="editAccessCode" placeholder="12345678" style="flex: 1;">
                            <button type="button" class="toggle-visibility" data-target="editAccessCode" title="Show/Hide">
                                👁️
                            </button>
                        </div>
                        <small data-i18n="access_code_hint">Get from printer settings → Network → Access Code</small>
                    </div>
                    <div class="form-group">
                        <label for="editSerialNumber" data-i18n="serial_number">Serial Number:</label>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="password" id="editSerialNumber" placeholder="01P00A123456789" style="flex: 1;">
                            <button type="button" class="toggle-visibility" data-target="editSerialNumber" title="Show/Hide">
                                👁️
                            </button>
                        </div>
                        <small data-i18n="serial_number_hint">Find on printer label or in settings</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="savePrinterChanges()">Save</button>
                    <button class="btn" onclick="closeEditPrinterModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Settings Modal -->
    <div id="telegramSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🤖 Telegram Settings</h3>
                <span class="close" onclick="closeTelegramSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="telegramBotToken">Bot Token:</label>
                    <input type="text" id="telegramBotToken" placeholder="1234567890:ABCdefGHIjklMNopQRstUVwxyz">
                    <small>Get this from @BotFather in Telegram</small>
                </div>
                <div class="form-group">
                    <label for="telegramChatId">Chat ID:</label>
                    <input type="text" id="telegramChatId" placeholder="123456789">
                    <small>Send /start to your bot and check logs</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="telegramEnabled"> <span id="labelEnableTelegram">Enable Telegram notifications</span>
                    </label>
                </div>
                <div class="notification-settings">
                    <h4 id="telegramNotifyTitle">Notify on:</h4>
                    <label><input type="checkbox" id="notifyPrintComplete" checked> <span id="labelPrintComplete">Print complete</span></label>
                    <label><input type="checkbox" id="notifyPrintStart" checked> <span id="labelPrintStart">Print start</span></label>
                    <label><input type="checkbox" id="notifyPrintError" checked> <span id="labelPrintError">Print error</span></label>
                    <label><input type="checkbox" id="notifyPrintPaused" checked> <span id="labelPrintPaused">Print paused</span></label>
                    <label><input type="checkbox" id="notifyPrinterOffline"> <span id="labelPrinterOffline">Printer offline</span></label>
                    <label><input type="checkbox" id="notifyPrinterOnline"> <span id="labelPrinterOnline">Printer online</span></label>
                    <label><input type="checkbox" id="notifyInefficiency" checked> <span id="labelInefficiency">Inefficiency event</span></label>
                    <label><input type="checkbox" id="notifyInefficiencyReason" checked> <span id="labelInefficiencyReason">Inefficiency reason saved</span></label>
                    <label><input type="checkbox" id="notifyProgramStart" checked> <span id="labelProgramStart">Program start</span></label>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-help" onclick="showTelegramHelpModal()" style="margin-right: auto;" data-i18n="help">❓ Help</button>
                    <button class="btn btn-primary" onclick="saveTelegramSettings()">Save</button>
                    <button class="btn btn-secondary" onclick="testTelegramConnection()">Test Connection</button>
                    <button class="btn" onclick="closeTelegramSettingsModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content" style="max-width: 1100px;">
            <div class="modal-header">
                <h3>📈 Analytics</h3>
                <span class="close" onclick="closeAnalyticsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group" style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                    <div>
                        <label id="analyticsPeriodLabel">Период:</label>
                        <select id="analyticsPeriod">
                            <option value="1d">За день</option>
                            <option value="7d">За неделю</option>
                            <option value="30d">За месяц</option>
                            <option value="custom">Произвольный</option>
                        </select>
                    </div>
                    <div>
                        <label id="analyticsPrinterLabel">Принтер:</label>
                        <select id="analyticsPrinter"></select>
                    </div>
                    <div id="analyticsCustomRange" style="display:none; gap:10px; align-items:end;">
                        <div>
                            <label id="analyticsFromLabel">С</label>
                            <input type="date" id="analyticsFrom" />
                        </div>
                        <div>
                            <label id="analyticsToLabel">По</label>
                            <input type="date" id="analyticsTo" />
                        </div>
                    </div>
                </div>

                <div class="printers-counter" style="margin-top:10px;">
                    <span class="counter printing"><span id="stat-print-time">0s</span><span style="margin-left:6px;" id="kpiPrintLabel">Общее время печати</span></span>
                    <span class="counter ready"><span id="stat-idle-time">0s</span><span style="margin-left:6px;" id="kpiIdleLabel">Общее время простоя</span></span>
                    <span class="counter complete"><span id="stat-efficiency">0.0%</span><span style="margin-left:6px;" id="kpiEffLabel">Эффективность</span></span>
                    <span class="counter error"><span id="stat-energy-cost">0</span><span style="margin-left:6px;" id="kpiCostLabel">Стоимость энергии</span></span>
                </div>

                <div class="tabs" style="display:flex; gap:20px; margin-top:15px;">
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('eff')" id="tabEffBtn">Эффективность</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('ineff')" id="tabIneffBtn">Неэффективность</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('energy')" id="tabEnergyBtn">Энергопотребление</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('details')" id="tabDetailsBtn">Детальная статистика</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('settings')" id="tabSettingsBtn">Настройки</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('help')" id="tabHelpBtn">❓ Помощь</button>
                </div>

                <div id="analyticsTabContent" style="margin-top:10px;">
                    <!-- content filled by renderer.js -->
                </div>
            </div>
        </div>
    </div>

    <!-- Inefficiency Comment Modal -->
    <div id="inefficiencyCommentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="ineffCommentModalTitle">📝 Add Comment</h3>
                <span class="close" onclick="closeInefficiencyCommentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <h4 id="ineffCommentPrinterName" style="color: #00d4ff; margin-bottom: 5px;">Printer Name</h4>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px; color: #888;">
                        <span><strong id="ineffCommentTypeLabel">Type:</strong> <span id="ineffCommentType">Gap</span></span>
                        <span><strong id="ineffCommentDurationLabel">Duration:</strong> <span id="ineffCommentDuration">15m</span></span>
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #666;">
                        <span id="ineffCommentPeriod">Period: 2024-01-01 10:00 - 10:15</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ineffCommentTextarea" id="ineffCommentLabel">Comment / Reason:</label>
                    <textarea 
                        id="ineffCommentTextarea" 
                        rows="5" 
                        placeholder="Enter the reason for this inefficiency period..."
                        style="width: 100%; padding: 10px; border: 1px solid #444; background: #2a2a2a; color: #fff; border-radius: 5px; font-family: inherit; resize: vertical;"
                    ></textarea>
                    <small id="ineffCommentHint" style="color: #888; display: block; margin-top: 5px;">
                        💡 Example: Material change, maintenance, waiting for parts, operator break, etc.
                    </small>
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveInefficiencyComment()">
                        <span id="ineffCommentSaveBtn">💾 Save Comment</span>
                    </button>
                    <button class="btn btn-danger" onclick="deleteInefficiencyComment()" id="ineffCommentDeleteBtn" style="display: none;">
                        <span id="ineffCommentDeleteText">🗑️ Delete</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeInefficiencyCommentModal()">
                        <span id="ineffCommentCancelBtn">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Analytics Confirmation Modal -->
    <div id="clearAnalyticsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="clearAnalyticsModalTitle">⚠️ Clear Analytics Data</h3>
                <span class="close" onclick="closeClearAnalyticsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="clearAnalyticsWarning1" style="font-size: 16px; line-height: 1.6; color: #e74c3c; font-weight: bold;">
                    ⚠️ Warning! This action is irreversible!
                </p>
                <p id="clearAnalyticsWarning2" style="font-size: 14px; line-height: 1.6; margin-top: 15px;">
                    All analytics data will be permanently deleted, including:
                </p>
                <ul style="margin-top: 10px; line-height: 1.8;">
                    <li id="clearAnalyticsItem1">Print and idle time history</li>
                    <li id="clearAnalyticsItem2">All status transition events</li>
                    <li id="clearAnalyticsItem3">Inefficiency periods and operator reports</li>
                    <li id="clearAnalyticsItem4">Energy consumption statistics</li>
                </ul>
                <p id="clearAnalyticsWarning3" style="font-size: 14px; line-height: 1.6; margin-top: 15px; color: #888;">
                    Power settings (wattage, cost per kWh) will be preserved.
                </p>
                <p id="clearAnalyticsConfirm" style="font-size: 14px; line-height: 1.6; margin-top: 15px; font-weight: bold;">
                    Are you sure you want to continue?
                </p>
                <div class="modal-footer" style="margin-top: 20px; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmClearAnalytics()">
                        <span id="clearAnalyticsYesBtn">Yes, Clear All Data</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeClearAnalyticsModal()">
                        <span id="clearAnalyticsNoBtn">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bambu Lab Info Modal -->
    <div id="bambuInfoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="bambuInfoModalTitle">🎋 Bambu Lab</h3>
                <span class="close" onclick="closeBambuInfoModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="font-size: 16px; line-height: 1.6;">
                    <strong id="bambuPrinterName"></strong>
                </p>
                <p id="bambuInfoMessage" style="font-size: 14px; line-height: 1.6; margin-top: 15px;">
                    ℹ️ Bambu Lab printers use mobile app <strong>Bambu Handy</strong> or <strong>Bambu Studio</strong> for control.
                </p>
                <p id="bambuInfoNoWeb" style="font-size: 14px; line-height: 1.6; margin-top: 10px; color: #888;">
                    There is no local web interface available for this printer type.
                </p>
                <div class="modal-footer" style="margin-top: 20px;">
                    <button class="btn btn-help" onclick="showBambuLabHelpModal()" style="margin-right: auto;">❓ <span id="bambuInfoHelpBtn">Help</span></button>
                    <button class="btn btn-primary" onclick="closeBambuInfoModal()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Scan Modal -->
    <div id="networkScanModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="networkScanModalTitle">🔍 Network Scanner</h3>
                <span class="close" onclick="closeNetworkScanModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- Scan Options -->
                <div id="scanOptions" class="form-group" style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="executeScan('quick')">
                        <span id="quickScanBtn">⚡ Quick Scan</span>
                    </button>
                    <button class="btn btn-secondary" onclick="executeScan('full')">
                        <span id="fullScanBtn">🌐 Full Scan</span>
                    </button>
                    <small id="scanHint" style="color: #888;">Quick scan checks common IP addresses (~150), Full scan checks entire subnet (~250)</small>
                </div>

                <!-- Scan Progress -->
                <div id="scanProgress" style="display: none; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <div class="spinner" style="width: 20px; height: 20px; border: 3px solid #333; border-top-color: #00d4ff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span id="scanProgressText">Scanning network...</span>
                    </div>
                    <div style="background: #2a2a2a; border-radius: 5px; overflow: hidden; height: 8px;">
                        <div id="scanProgressBar" style="background: linear-gradient(90deg, #00d4ff, #0088ff); height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                        <span id="scanProgressDetails">0 / 0 IPs checked</span>
                    </div>
                </div>

                <!-- Scan Results -->
                <div id="scanResults" style="display: none;">
                    <h4 id="scanResultsTitle" style="margin-bottom: 15px;">Found Printers (<span id="foundPrintersCount">0</span>)</h4>
                    <div id="scanResultsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Results will be dynamically added here -->
                    </div>
                </div>

                <!-- No Results Message -->
                <div id="scanNoResults" style="display: none; text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">🔍</div>
                    <p id="noResultsMessage" style="font-size: 16px; color: #888;">No printers found on the network</p>
                    <small id="noResultsTip" style="color: #666;">Make sure printers are powered on and connected to the same network</small>
                </div>

                <div class="modal-footer" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="closeNetworkScanModal()">
                        <span id="scanCloseBtn">Close</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio element for completion sound -->
    <audio id="completionSound" preload="auto">
        <source src="windows-xp-print-complete.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <!-- Temperature Sensors Selection Modal -->
    <div id="tempSensorsModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>🌡️ <span id="tempSensorsModalTitle"></span></h3>
                <span class="close" onclick="closeTempSensorsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="tempSensorsDescription" style="color: #ccc; margin-bottom: 15px;">
                    <strong id="tempSensorsForAdvanced"></strong> <span id="tempSensorsDescText"></span><br>
                    <span id="tempSensorsAutoRecommended"></span>
                </p>
                <div id="tempSensorsContent" style="margin: 20px 0;">
                    <!-- Dynamically filled -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="saveTempSensorsSelection()"><span id="tempSensorsSaveBtn"></span></button>
                    <button class="btn" onclick="closeTempSensorsModal()"><span id="tempSensorsSkipBtn"></span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Help Modal -->
    <div id="telegramHelpModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="telegramHelpTitle">Telegram Bot Setup Help</h2>
                <span class="close" onclick="closeTelegramHelpModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="analytics-card" style="margin: 0;">
                    <div class="analytics-help-content" id="telegramHelpContent">
                        <!-- Content will be filled by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeTelegramHelpModal()" data-i18n="close">Close</button>
            </div>
        </div>
    </div>

    <!-- Bambu Lab Help Modal -->
    <div id="bambuLabHelpModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="bambuLabHelpTitle">Bambu Lab Printer Setup</h2>
                <span class="close" onclick="closeBambuLabHelpModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="analytics-card" style="margin: 0;">
                    <div class="analytics-help-content" id="bambuLabHelpContent">
                        <!-- Content will be filled by JavaScript -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeBambuLabHelpModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="../node_modules/chart.js/dist/chart.umd.js"></script>
    <script src="translations.js"></script>
    <script src="renderer.js"></script>
    
    <script>
        // Функция для отправки критических уведомлений о сменах (дубль из renderer.js для надежности)
        if (typeof sendCriticalShiftNotification === 'undefined') {
            async function sendCriticalShiftNotification(title, message, operatorName, operatorUsername, operatorRole) {
                try {
                    const telegramConfig = await window.electronAPI.storeGet('telegramConfig', null);
                    if (!telegramConfig || !telegramConfig.enabled || !telegramConfig.botToken || !telegramConfig.chatId) {
                        return false;
                    }
                    
                    const roleEmoji = operatorRole === 'admin' ? '👑' : '👤';
                    const criticalHeader = '🚨 *КРИТИЧЕСКОЕ УВЕДОМЛЕНИЕ* 🚨';
                    
                    const fullMessage = `${criticalHeader}\n\n` +
                                       `📋 *${title}*\n\n` +
                                       `💬 ${message}\n\n` +
                                       `${roleEmoji} *Оператор:* ${operatorName} (${operatorUsername})\n` +
                                       `⏰ *Время:* ${new Date().toLocaleString()}`;
                    
                    const url = `https://api.telegram.org/bot${telegramConfig.botToken}/sendMessage`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            chat_id: telegramConfig.chatId,
                            text: fullMessage,
                            parse_mode: 'Markdown',
                            disable_notification: false
                        })
                    });
                    
                    const data = await response.json();
                    return data.ok;
                } catch (error) {
                    console.error('Failed to send critical Telegram notification:', error);
                    return false;
                }
            }
        }
    </script>
    
    <script>
        // Защита от закрытия приложения без подтверждения
        window.electronAPI.onBeforeQuit(async () => {
            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            
            if (currentUser && currentUser.isSuperAdmin) {
                try {
                    const currentShift = await window.electronAPI.getCurrentShift();
                    if (currentShift) {
                        await window.electronAPI.endShift(currentShift.userId);
                    }
                } catch (e) {}
                await window.electronAPI.storeSet('currentUser', null);
                await window.electronAPI.storeSet('isAuthenticated', false);
                window.electronAPI.confirmQuit(true);
                return;
            }

            const currentShift = await window.electronAPI.getCurrentShift();
            
            if (!currentUser || !currentShift) {
                window.electronAPI.confirmQuit(true);
                return;
            }
            
            // Показываем диалог с инструкцией использовать кнопку "Выход"
            alert(`Для выхода из программы используйте кнопку "🚪 Выход" на верхней панели.\n\nТам вы сможете выбрать:\n- Передать смену другому оператору\n- Завершить смену и выйти`);
                window.electronAPI.confirmQuit(false);
        });
        
        // Проверка аутентификации при загрузке
        window.addEventListener('DOMContentLoaded', async () => {
            // Проверяем, инициализирована ли система
            const isInitialized = await window.electronAPI.isSystemInitialized();
            if (!isInitialized) {
                // Перенаправляем на настройку администратора
                window.location.href = 'setup-admin.html';
                return;
            }
            
            // Проверяем, есть ли активная сессия
            const isAuthenticated = await window.electronAPI.storeGet('isAuthenticated', false);
            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            
            if (!isAuthenticated || !currentUser) {
                // Перенаправляем на логин
                window.location.href = 'login.html';
                return;
            }

            // Инициализируем панель смены
            await initShiftPanel();
            
            // Инициализируем суперадминскую панель
            await initSuperAdminPanel();
        });

        // ========== SHIFT PANEL MANAGEMENT ==========
        
        let shiftUpdateInterval = null;

        async function initShiftPanel() {
            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            const currentShift = await window.electronAPI.getCurrentShift();
            
            if (!currentUser) return;

            // Показываем панель
            document.getElementById('shiftInfoBar').style.display = 'flex';

            // Показываем кнопку управления пользователями только для обычного админа
            if (currentUser.role === 'admin' && !currentUser.isSuperAdmin) {
                document.getElementById('btnManageUsers').style.display = 'block';
            }

            // Обновляем информацию о смене
            updateShiftInfo();

            // Запускаем периодическое обновление
            if (shiftUpdateInterval) clearInterval(shiftUpdateInterval);
            shiftUpdateInterval = setInterval(updateShiftInfo, 60000); // каждую минуту
        }

        async function updateShiftInfo() {
            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            const currentShift = await window.electronAPI.getCurrentShift();
            
            if (!currentUser) return;

            const usernameEl = document.getElementById('shiftUsername');
            const durationEl = document.getElementById('shiftDuration');

            usernameEl.textContent = `${currentUser.displayName} (${currentUser.username})`;

            if (currentShift) {
                const duration = Date.now() - new Date(currentShift.startTime).getTime();
                durationEl.textContent = `Смена: ${formatDuration(duration)}`;
            } else {
                durationEl.textContent = 'Нет активной смены';
            }
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);

            if (hours > 0) {
                return `${hours}ч ${minutes % 60}м`;
            } else if (minutes > 0) {
                return `${minutes}м`;
            } else {
                return `${seconds}с`;
            }
        }

        async function logout() {
            console.log('logout() called');
            showLogoutModal();
        }

        function showLogoutModal() {
            console.log('showLogoutModal() called');
            // Удаляем старое модальное окно если есть
            const oldModal = document.getElementById('logoutModal');
            if (oldModal) {
                console.log('Removing old logout modal');
                oldModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'logoutModal';
            modal.className = 'modal';
            modal.style.cssText = 'display: block !important;';
            console.log('Created logout modal with display:', modal.style.display);

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>🚪 Выход из системы</h3>
                        <span class="close" onclick="closeLogoutModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 20px; font-size: 16px;">Выберите действие:</p>
                        
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px;" onclick="transferShift()">
                            🔄 Передать смену другому оператору
                        </button>
                        
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 15px; padding: 15px; font-size: 16px; background: #dc3545;" onclick="endShiftAndLogout()">
                            🛑 Завершить смену и выйти
                        </button>
                        
                        <button class="btn" style="width: 100%; padding: 12px;" onclick="closeLogoutModal()">
                            ❌ Отмена
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            console.log('Logout modal appended to body, display:', window.getComputedStyle(modal).display);
        }

        function closeLogoutModal() {
            console.log('closeLogoutModal() called');
            const modal = document.getElementById('logoutModal');
            if (modal) {
                modal.remove();
                console.log('Logout modal removed');
            }
        }

        async function transferShift() {
            closeLogoutModal();
            
            try {
                const currentUser = await window.electronAPI.storeGet('currentUser', null);
                
                // Выходим БЕЗ завершения смены
                const result = await window.electronAPI.logout(false);
                if (result.success) {
                    // Отправляем Telegram уведомление о передаче смены
                    if (currentUser && typeof sendCriticalShiftNotification === 'function') {
                        try {
                            await sendCriticalShiftNotification(
                                'Передача смены',
                                `Оператор передает смену другому оператору`,
                                currentUser.displayName,
                                currentUser.username,
                                currentUser.role
                            );
                        } catch (e) {
                            console.error('Failed to send shift transfer notification:', e);
                        }
                    }
                    // Перенаправит на экран логина автоматически
                }
            } catch (error) {
                alert('Ошибка при передаче смены: ' + error.message);
            }
        }

        async function endShiftAndLogout() {
            console.log('endShiftAndLogout() called');
            closeLogoutModal();
            
            // Показываем модальное окно для ввода пароля
            showPasswordConfirmModal();
        }

        function showPasswordConfirmModal() {
            const modal = document.createElement('div');
            modal.id = 'passwordConfirmModal';
            modal.className = 'modal';
            modal.style.cssText = 'display: block !important;';

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3>🔐 Подтверждение завершения смены</h3>
                        <span class="close" onclick="closePasswordConfirmModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p style="margin-bottom: 15px; font-size: 14px; color: #666;" id="passwordConfirmUserInfo">Загрузка...</p>
                        
                        <div class="form-group">
                            <label for="confirmPasswordInput">Введите ваш пароль для подтверждения:</label>
                            <div style="position: relative;">
                                <input 
                                    type="password" 
                                    id="confirmPasswordInput" 
                                    placeholder="Введите пароль"
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px; pointer-events: auto !important; cursor: text !important;"
                                    autofocus
                                    tabindex="1"
                                >
                                <button type="button" onclick="toggleConfirmPassword()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666; padding: 5px;">👁️</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="confirmEndShift()">✅ Подтвердить</button>
                            <button class="btn btn-secondary" style="flex: 1;" onclick="closePasswordConfirmModal()">❌ Отмена</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Заполняем информацию о пользователе
            (async () => {
                const currentUser = await window.electronAPI.storeGet('currentUser', null);
                if (currentUser) {
                    document.getElementById('passwordConfirmUserInfo').textContent = 
                        `Пользователь: ${currentUser.displayName} (${currentUser.username})`;
                }
                // Фокусируем поле пароля и убираем все блокировки
                setTimeout(() => {
                    const input = document.getElementById('confirmPasswordInput');
                    if (input) {
                        // Явно убираем все возможные блокировки
                        input.disabled = false;
                        input.readOnly = false;
                        input.removeAttribute('disabled');
                        input.removeAttribute('readonly');
                        input.style.pointerEvents = 'auto';
                        input.style.cursor = 'text';
                        input.focus();
                        console.log('Password input enabled and focused');
                    }
                }, 100);
            })();

            // Enter для подтверждения
            document.getElementById('confirmPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    confirmEndShift();
                }
            });
        }

        function toggleConfirmPassword() {
            const input = document.getElementById('confirmPasswordInput');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = '🙈';
            } else {
                input.type = 'password';
                btn.textContent = '👁️';
            }
        }

        function closePasswordConfirmModal() {
            const modal = document.getElementById('passwordConfirmModal');
            if (modal) modal.remove();
        }

        async function confirmEndShift() {
            const password = document.getElementById('confirmPasswordInput').value;
            
            if (!password) {
                alert('Введите пароль');
                return;
            }

            console.log('Verifying password...');

            try {
                const currentUser = await window.electronAPI.storeGet('currentUser', null);
                
                // Проверяем пароль
                const authResult = await window.electronAPI.authenticateUser(currentUser.username, password);
                console.log('Auth result:', authResult.success);
                
                if (!authResult.success) {
                    alert('Неверный пароль! Выход отменен.');
                    return;
                }

                closePasswordConfirmModal();
                console.log('Password verified, sending Telegram notification...');

                // Отправляем Telegram уведомление о завершении смены
                if (typeof sendCriticalShiftNotification === 'function') {
                    try {
                        await sendCriticalShiftNotification(
                            'Завершение смены',
                            `Оператор завершил смену и закрыл программу`,
                            currentUser.displayName,
                            currentUser.username,
                            currentUser.role
                        );
                        console.log('Telegram notification sent');
                    } catch (e) {
                        console.error('Failed to send shift end notification:', e);
                    }
                }

                console.log('Quitting application...');
                // Завершаем смену и закрываем приложение
                await window.electronAPI.quitApp();
            } catch (error) {
                console.error('Error in confirmEndShift:', error);
                alert('Ошибка при выходе: ' + error.message);
            }
        }

        // ========== SUPERADMIN PANEL ==========

        async function initSuperAdminPanel() {
            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            if (currentUser && currentUser.isSuperAdmin) {
                createSuperAdminSecretButton();
            }
        }

        function createSuperAdminSecretButton() {
            // Создаем невидимую секретную кнопку 20x20px в верхнем левом углу
            const btn = document.createElement('div');
            btn.style.cssText = `
                position: fixed;
                left: 0;
                top: 0;
                width: 20px;
                height: 20px;
                cursor: default;
                z-index: 99999;
                background: transparent;
                opacity: 0;
            `;
            
            btn.addEventListener('click', () => {
                console.log('Secret SuperAdmin button clicked!');
                showSuperAdminPanel();
            });
            
            document.body.appendChild(btn);
            
            console.log('SuperAdmin secret button created (20x20px at top-left corner)');
        }

        async function showSuperAdminPanel() {
            // Удаляем старую панель если есть
            const oldModal = document.getElementById('superAdminModal');
            if (oldModal) oldModal.remove();

            const modal = document.createElement('div');
            modal.id = 'superAdminModal';
            modal.style.cssText = `
                display: block !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.95);
                z-index: 999999;
                overflow-y: auto;
                padding: 20px;
            `;

            const { admins, operators } = await window.electronAPI.getUsers();
            const allUsers = [...admins, ...operators];

            modal.innerHTML = `
                <div style="max-width: 1200px; margin: 40px auto; background: #1a1a1a; border-radius: 20px; padding: 30px; color: #fff;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                        <h2 style="color: #ff0000; margin: 0;">🔴 SUPERADMIN PANEL 🔴</h2>
                        <button onclick="closeSuperAdminPanel()" style="background: #ff0000; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">✕ Close</button>
                    </div>

                    <div style="background: #2a2a2a; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px;">All Users (${allUsers.length})</h3>
                        <table style="width: 100%; border-collapse: collapse; color: white;">
                            <thead>
                                <tr style="background: #333; text-align: left;">
                                    <th style="padding: 12px; border: 1px solid #444;">Username</th>
                                    <th style="padding: 12px; border: 1px solid #444;">Display Name</th>
                                    <th style="padding: 12px; border: 1px solid #444;">Role</th>
                                    <th style="padding: 12px; border: 1px solid #444;">Active</th>
                                    <th style="padding: 12px; border: 1px solid #444;">Created</th>
                                    <th style="padding: 12px; border: 1px solid #444;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allUsers.map(user => `
                                    <tr style="border-bottom: 1px solid #444;">
                                        <td style="padding: 12px; border: 1px solid #444;">${user.username}</td>
                                        <td style="padding: 12px; border: 1px solid #444;">${user.displayName}</td>
                                        <td style="padding: 12px; border: 1px solid #444;">
                                            <span style="background: ${user.role === 'admin' ? '#ff0000' : '#0088cc'}; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                ${user.role === 'admin' ? '👑 ADMIN' : '👤 OPERATOR'}
                                            </span>
                                        </td>
                                        <td style="padding: 12px; border: 1px solid #444;">${user.isActive ? '✅ Active' : '❌ Inactive'}</td>
                                        <td style="padding: 12px; border: 1px solid #444; font-size: 11px;">${new Date(user.createdAt).toLocaleString('ru-RU')}</td>
                                        <td style="padding: 12px; border: 1px solid #444;">
                                            <button onclick="superAdminResetPassword('${user.id}')" style="background: #ffc107; color: #000; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px;">🔑 Reset Password</button>
                                            ${user.role !== 'admin' ? `<button onclick="superAdminDeleteUser('${user.id}')" style="background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; margin: 2px;">🗑️ Delete</button>` : ''}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>

                    <div style="background: #2a2a2a; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px;">Quick Actions</h3>
                        <button onclick="showSuperAdminAddOperator()" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-right: 10px;">➕ Quick Add Operator</button>
                        <button onclick="showUserManagementModal()" style="background: #0088cc; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">👥 User Management</button>
                    </div>

                    <div style="background: #2a2a2a; padding: 20px; border-radius: 10px;">
                        <h3 style="color: #ff6b6b; margin-bottom: 15px;">System Info</h3>
                        <pre style="background: #1a1a1a; color: #0f0; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; overflow-x: auto;">${JSON.stringify({
                            totalUsers: allUsers.length,
                            admins: admins.length,
                            operators: operators.length,
                            activeOperators: operators.filter(o => o.isActive).length
                        }, null, 2)}</pre>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeSuperAdminPanel() {
            const modal = document.getElementById('superAdminModal');
            if (modal) modal.remove();
        }

        async function superAdminResetPassword(userId) {
            showResetPasswordModal(userId, true);
        }

        async function superAdminDeleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }

            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            
            try {
                const result = await window.electronAPI.removeOperator(currentUser.id, userId);

                if (result.success) {
                    alert('Пользователь удален');
                    closeSuperAdminPanel();
                    showSuperAdminPanel(); // Обновляем панель
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        async function showSuperAdminAddOperator() {
            closeSuperAdminPanel();
            showUserManagementModal();
        }

        // ========== USER MANAGEMENT MODAL ==========

        function openUserManagement() {
            showUserManagementModal();
        }

        async function showUserManagementModal() {
            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            if (!currentUser || (currentUser.role !== 'admin' && !currentUser.isSuperAdmin)) {
                alert('Только администраторы могут управлять пользователями');
                return;
            }

            // Удаляем старое модальное окно если есть
            const oldModal = document.getElementById('userManagementModal');
            if (oldModal) oldModal.remove();

            const modal = document.createElement('div');
            modal.id = 'userManagementModal';
            modal.className = 'modal';
            modal.style.cssText = 'display: block !important;';

            const operators = await window.electronAPI.getAllOperators();

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>👥 Управление пользователями</h3>
                        <span class="close" onclick="closeUserManagement()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="showAddOperatorForm()">➕ Добавить оператора</button>
                        </div>

                        <div id="addOperatorForm" style="display: none; background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4>Новый оператор</h4>
                            <div class="form-group">
                                <label>Логин:</label>
                                <input type="text" id="newOperatorUsername" placeholder="operator1">
                            </div>
                            <div class="form-group">
                                <label>Отображаемое имя:</label>
                                <input type="text" id="newOperatorDisplayName" placeholder="Иван Иванов">
                            </div>
                            <div class="form-group">
                                <label>Пароль:</label>
                                <input type="password" id="newOperatorPassword" placeholder="минимум 4 символа">
                            </div>
                            <button class="btn btn-primary" onclick="addOperator()">Создать</button>
                            <button class="btn btn-secondary" onclick="hideAddOperatorForm()">Отмена</button>
                        </div>

                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f0f0f0;">
                                    <th style="padding: 12px; text-align: left;">Пользователь</th>
                                    <th style="padding: 12px; text-align: left;">Роль</th>
                                    <th style="padding: 12px; text-align: left;">Статус</th>
                                    <th style="padding: 12px; text-align: left;">Создан</th>
                                    <th style="padding: 12px; text-align: left;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${operators.map(op => `
                                    <tr style="border-bottom: 1px solid #ddd;">
                                        <td style="padding: 12px;">
                                            <strong>${op.displayName}</strong><br>
                                            <small style="color: #666;">${op.username}</small>
                                        </td>
                                        <td style="padding: 12px;">
                                            <span style="background: #0088cc; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                                                ${op.role === 'admin' ? '👑 ADMIN' : '👤 OPERATOR'}
                                            </span>
                                        </td>
                                        <td style="padding: 12px;">
                                            ${op.isActive ? '✅ Активен' : '❌ Неактивен'}
                                        </td>
                                        <td style="padding: 12px; font-size: 11px;">
                                            ${new Date(op.createdAt).toLocaleString('ru-RU')}
                                        </td>
                                        <td style="padding: 12px;">
                                            ${op.role !== 'admin' ? `
                                                <button class="btn btn-small" onclick="resetPassword('${op.id}')">🔑 Сбросить пароль</button>
                                                <button class="btn btn-small" onclick="toggleStatus('${op.id}')">${op.isActive ? '❌ Деактивировать' : '✅ Активировать'}</button>
                                                <button class="btn btn-small" style="background: #dc3545;" onclick="removeOperator('${op.id}')">🗑️ Удалить</button>
                                            ` : '<em>Администратор</em>'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeUserManagement() {
            const modal = document.getElementById('userManagementModal');
            if (modal) modal.remove();
        }

        function showAddOperatorForm() {
            document.getElementById('addOperatorForm').style.display = 'block';
        }

        function hideAddOperatorForm() {
            document.getElementById('addOperatorForm').style.display = 'none';
            document.getElementById('newOperatorUsername').value = '';
            document.getElementById('newOperatorDisplayName').value = '';
            document.getElementById('newOperatorPassword').value = '';
        }

        async function addOperator() {
            const username = document.getElementById('newOperatorUsername').value.trim();
            const displayName = document.getElementById('newOperatorDisplayName').value.trim();
            const password = document.getElementById('newOperatorPassword').value;

            if (!username || username.length < 3) {
                alert('Логин должен содержать минимум 3 символа');
                return;
            }

            if (!password || password.length < 4) {
                alert('Пароль должен содержать минимум 4 символа');
                return;
            }

            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            
            try {
                // Для суперадмина передаем его ID, обработчик в main.js разберется
                const result = await window.electronAPI.addOperator(
                    currentUser.id || 'superadmin', 
                    username, 
                    password, 
                    displayName || username
                );

                if (result.success) {
                    alert(`Оператор успешно добавлен!\n\nЛогин: ${username}\nПароль: ${password}\n\nОбязательно запишите!`);
                    closeUserManagement();
                    showUserManagementModal(); // Обновляем список
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        async function resetPassword(operatorId) {
            showResetPasswordModal(operatorId, false);
        }

        function showResetPasswordModal(operatorId, isSuperAdmin = false) {
            const modal = document.createElement('div');
            modal.id = 'resetPasswordModal';
            modal.className = 'modal';
            modal.style.cssText = 'display: block !important;';

            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header">
                        <h3>🔑 Сброс пароля оператора</h3>
                        <span class="close" onclick="closeResetPasswordModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="newPasswordInput">Введите новый пароль (минимум 4 символа):</label>
                            <div style="position: relative;">
                                <input 
                                    type="password" 
                                    id="newPasswordInput" 
                                    placeholder="Новый пароль"
                                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 15px;"
                                    autofocus
                                >
                                <button type="button" onclick="toggleNewPassword()" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #666; padding: 5px;">👁️</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-primary" style="flex: 1;" onclick="confirmResetPassword('${operatorId}', ${isSuperAdmin})">✅ Сбросить пароль</button>
                            <button class="btn btn-secondary" style="flex: 1;" onclick="closeResetPasswordModal()">❌ Отмена</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Фокусируем поле
            setTimeout(() => {
                const input = document.getElementById('newPasswordInput');
                if (input) input.focus();
            }, 100);

            // Enter для подтверждения
            document.getElementById('newPasswordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    confirmResetPassword(operatorId, isSuperAdmin);
                }
            });
        }

        function toggleNewPassword() {
            const input = document.getElementById('newPasswordInput');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = '🙈';
            } else {
                input.type = 'password';
                btn.textContent = '👁️';
            }
        }

        function closeResetPasswordModal() {
            const modal = document.getElementById('resetPasswordModal');
            if (modal) modal.remove();
        }

        async function confirmResetPassword(operatorId, isSuperAdmin) {
            const newPassword = document.getElementById('newPasswordInput').value;
            
            if (!newPassword || newPassword.length < 4) {
                alert('Пароль должен содержать минимум 4 символа');
                return;
            }

            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            
            try {
                const result = await window.electronAPI.resetOperatorPassword(
                    currentUser.id || 'superadmin', 
                    operatorId, 
                    newPassword
                );

                if (result.success) {
                    closeResetPasswordModal();
                    alert(`Пароль успешно сброшен!\n\nНовый пароль: ${newPassword}\n\nОбязательно запишите!`);
                    
                    // Обновляем панели если открыты
                    if (isSuperAdmin) {
                        const superModal = document.getElementById('superAdminModal');
                        if (superModal) {
                            superModal.remove();
                            showSuperAdminPanel();
                        }
                    } else {
                        const userModal = document.getElementById('userManagementModal');
                        if (userModal) {
                            userModal.remove();
                            showUserManagementModal();
                        }
                    }
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        async function toggleStatus(operatorId) {
            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            
            try {
                const result = await window.electronAPI.toggleOperatorStatus(currentUser.id || 'superadmin', operatorId);

                if (result.success) {
                    closeUserManagement();
                    showUserManagementModal(); // Обновляем список
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }

        async function removeOperator(operatorId) {
            if (!confirm('Вы уверены, что хотите удалить этого оператора?')) {
                return;
            }

            const currentUser = await window.electronAPI.storeGet('currentUser', null);
            
            try {
                const result = await window.electronAPI.removeOperator(currentUser.id || 'superadmin', operatorId);

                if (result.success) {
                    alert('Оператор удален');
                    closeUserManagement();
                    showUserManagementModal(); // Обновляем список
                } else {
                    alert('Ошибка: ' + result.error);
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
    </script>
</body>
</html>