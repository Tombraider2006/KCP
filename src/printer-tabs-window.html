<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http:; script-src 'self' 'unsafe-inline' 'unsafe-eval';">
    <title id="windowTitle">3D Printer Interfaces</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ===== –°–ü–ï–¶–ò–§–ò–ß–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –û–ö–ù–ê –í–ö–õ–ê–î–û–ö ===== */
        body {
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(135deg, #0a1628 0%, #1a2942 50%, #0d1b2a 100%);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(0, 255, 255, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(0, 150, 255, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        /* –ö–ù–û–ü–ö–ê –í–û–ó–í–†–ê–¢–ê */
        .back-to-main {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.3), rgba(40, 167, 69, 0.2));
            color: #5dff8f;
            border: none;
            border-bottom: 2px solid rgba(40, 167, 69, 0.5);
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(93, 255, 143, 0.5);
            position: relative;
            z-index: 2;
            box-shadow: 0 2px 15px rgba(40, 167, 69, 0.3);
        }
        
        .back-to-main:hover {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.4), rgba(40, 167, 69, 0.3));
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5);
            border-bottom-color: rgba(40, 167, 69, 0.7);
        }
        
        .back-to-main:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.4);
        }
        
        .back-icon {
            font-size: 20px;
            text-shadow: 0 0 15px rgba(93, 255, 143, 0.8);
        }
        
        /* –ö–û–ù–¢–ï–ô–ù–ï–† –í–ö–õ–ê–î–û–ö */
        .tabs-container {
            display: flex;
            background: rgba(13, 27, 42, 0.8);
            border-bottom: 2px solid rgba(0, 255, 255, 0.3);
            overflow-x: auto;
            min-height: 45px;
            position: relative;
            z-index: 2;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        /* –í–ö–õ–ê–î–ö–ê */
        .tab {
            padding: 12px 15px;
            background: rgba(10, 22, 40, 0.6);
            color: #7ea8c8;
            border: none;
            border-right: 1px solid rgba(0, 212, 255, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: auto;
            max-width: 220px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
        }

        .tab::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            background: rgba(0, 212, 255, 0.1);
            color: #00d4ff;
        }

        .tab:hover::before {
            background: rgba(0, 212, 255, 0.4);
        }
        
        .tab.active {
            background: rgba(0, 212, 255, 0.15);
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            border-right-color: rgba(0, 212, 255, 0.4);
        }

        .tab.active::before {
            background: linear-gradient(90deg, #00d4ff, #4dabf7);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
        }
        
        .tab-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 14px;
            max-width: 150px;
        }
        
        .tab-close {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.4);
            color: #ff6b6b;
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 18px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
        }
        
        .tab-close:hover {
            background: rgba(220, 53, 69, 0.4);
            border-color: rgba(220, 53, 69, 0.6);
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }
        
        /* –ö–û–ù–¢–ï–ù–¢ –í–ö–õ–ê–î–û–ö */
        .tab-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .iframe-container {
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
        }
        
        .iframe-container.active {
            display: block;
        }
        
        /* –°–û–û–ë–©–ï–ù–ò–ï "–ù–ï–¢ –í–ö–õ–ê–î–û–ö" */
        .no-tabs {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            flex-direction: column;
            gap: 15px;
            background: rgba(10, 22, 40, 0.3);
            border: 2px dashed rgba(0, 212, 255, 0.3);
            margin: 20px;
            border-radius: 15px;
            padding: 40px;
        }

        .no-tabs #noTabsTitle {
            color: #00d4ff;
            font-size: 24px;
            font-weight: 600;
            text-shadow: 0 0 15px rgba(0, 212, 255, 0.5);
        }
        
        .no-tabs .loading-message {
            color: #7ea8c8;
            font-size: 16px;
        }
        
        .printer-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #000;
        }

        /* –ò–ù–î–ò–ö–ê–¢–û–† –ó–ê–ì–†–£–ó–ö–ò */
        .loading-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(10, 22, 40, 0.98), rgba(13, 27, 42, 0.98));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 10;
            color: #00d4ff;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 212, 255, 0.2);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-indicator p {
            font-size: 16px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* –°–û–û–ë–©–ï–ù–ò–ï –û–ë –û–®–ò–ë–ö–ï */
        .error-message {
            color: #ff6b6b;
            padding: 25px;
            text-align: center;
            background: rgba(220, 53, 69, 0.15);
            border: 2px solid rgba(220, 53, 69, 0.4);
            border-radius: 12px;
            margin: 20px;
            max-width: 600px;
            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
        }

        .error-message h3 {
            margin-bottom: 15px;
            color: #ff6b6b;
            font-size: 20px;
            text-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        .error-message p {
            color: #b8d4e8;
            margin: 8px 0;
            font-size: 14px;
        }

        .error-message ul {
            text-align: left;
            margin: 15px auto;
            padding-left: 20px;
            max-width: 400px;
            color: #7ea8c8;
        }

        .error-message li {
            margin: 8px 0;
        }

        .retry-btn {
            background: rgba(0, 123, 255, 0.3);
            color: #4dabf7;
            border: 1px solid rgba(0, 123, 255, 0.5);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
        }

        .retry-btn:hover {
            background: rgba(0, 123, 255, 0.4);
            border-color: rgba(0, 123, 255, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.5);
        }

        /* –°–ö–†–û–õ–õ–ë–ê–† –î–õ–Ø –í–ö–õ–ê–î–û–ö */
        .tabs-container::-webkit-scrollbar {
            height: 8px;
        }

        .tabs-container::-webkit-scrollbar-track {
            background: rgba(10, 22, 40, 0.5);
        }

        .tabs-container::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.3);
            border-radius: 4px;
        }

        .tabs-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 212, 255, 0.5);
        }
    </style>
</head>
<body>
    <!-- –ö–ù–û–ü–ö–ê –í–û–ó–í–†–ê–¢–ê -->
    <button class="back-to-main" onclick="goBackToMain()">
        <span class="back-icon">‚Üê</span>
        <span id="backButtonText">–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</span>
    </button>
    
    <div class="tabs-container" id="tabsContainer"></div>
    <div class="tab-content" id="tabContent">
        <div class="no-tabs" id="noTabsMessage">
            <div id="noTabsTitle">–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤</div>
            <div class="loading-message" id="noTabsHint">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã</div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–ü–†–ï–î–ï–õ–ï–ù–ò–Ø –Ø–ó–´–ö–ê
        async function getBrowserLanguage() {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –∏–∑ store
            try {
                const { ipcRenderer } = require('electron');
                const savedLang = await ipcRenderer.invoke('store-get', 'appLanguage', null);
                if (savedLang) {
                    return savedLang;
                }
            } catch (error) {
                console.error('Error getting saved language:', error);
            }
            
            // Fallback –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–π —è–∑—ã–∫
            return navigator.language.toLowerCase().startsWith('ru') ? 'ru' : 'en';
        }

        // –ü–ï–†–ï–í–û–î–´ –î–õ–Ø –û–ö–ù–ê –í–ö–õ–ê–î–û–ö
        const TAB_TRANSLATIONS = {
            ru: {
                'back_to_main': '–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω',
                'printer_interfaces': '–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤',
                'no_open_interfaces': '–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤',
                'click_printer_cards_to_open': '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏–Ω—Ç–µ—Ä–æ–≤ —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã',
                'loading_interface': '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
                'interface_loaded': '–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞–≥—Ä—É–∂–µ–Ω',
                'interface_load_failed': '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å',
                'check_printer_connection': '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø—Ä–∏–Ω—Ç–µ—Ä—É',
                'retry_loading': '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É',
                'printer': '–ü—Ä–∏–Ω—Ç–µ—Ä',
                'error': '–û—à–∏–±–∫–∞',
                'connection_error': '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è',
                'please_check': '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:',
                'printer_powered_on': '–ü—Ä–∏–Ω—Ç–µ—Ä –≤–∫–ª—é—á–µ–Ω',
                'network_working': '–°–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç',
                'web_accessible': '–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ'
            },
            en: {
                'back_to_main': 'Back to main screen',
                'printer_interfaces': 'Printer Interfaces',
                'no_open_interfaces': 'No open interfaces',
                'click_printer_cards_to_open': 'Click on printer cards to open interfaces',
                'loading_interface': 'Loading interface',
                'interface_loaded': 'Interface loaded',
                'interface_load_failed': 'Failed to load interface',
                'check_printer_connection': 'Check printer connection',
                'retry_loading': 'Retry loading',
                'printer': 'Printer',
                'error': 'Error',
                'connection_error': 'Connection error',
                'please_check': 'Please check:',
                'printer_powered_on': 'Printer is powered on',
                'network_working': 'Network connection is working',
                'web_accessible': 'Web interface is accessible in browser'
            }
        };

        // –¢–µ–∫—É—â–∏–π —è–∑—ã–∫ (–∫–µ—à–∏—Ä—É–µ–º –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
        let currentLang = 'en';

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ü–ï–†–ï–í–û–î–ê
        function t(key) {
            return TAB_TRANSLATIONS[currentLang][key] || key;
        }

        // –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        async function updateInterfaceLanguage() {
            currentLang = await getBrowserLanguage();
            document.getElementById('windowTitle').textContent = t('printer_interfaces');
            document.getElementById('backButtonText').textContent = t('back_to_main');
            document.getElementById('noTabsTitle').textContent = t('no_open_interfaces');
            document.getElementById('noTabsHint').textContent = t('click_printer_cards_to_open');
        }

        // –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–û–ó–í–†–ê–¢–ê –ù–ê –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù
        function goBackToMain() {
            console.log('Returning to main window...');
            ipcRenderer.send('focus-main-window');
        }

        class PrinterTabsManager {
            constructor() {
                this.tabs = new Map();
                this.activeTabId = null;
                this.init();
            }

            init() {
                console.log('PrinterTabsManager initialized');
                this.setupIPC();
                this.setupPostMessageProxy();
                this.renderTabs();
                // –û–ë–ù–û–í–õ–Ø–ï–ú –ò–ù–¢–ï–†–§–ï–ô–° –ü–†–ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò
                updateInterfaceLanguage();
            }

            setupIPC() {
                ipcRenderer.on('add-printer-tab', (event, printerData) => {
                    console.log('Received add-printer-tab event:', printerData);
                    this.addTab(printerData);
                });

                ipcRenderer.on('focus-printer-tab', (event, printerId) => {
                    console.log('Received focus-printer-tab event:', printerId);
                    this.focusTab(printerId);
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö Bambu Lab
                ipcRenderer.on('bambu-data-update', (event, printerId, data) => {
                    console.log('Received bambu-data-update for printer:', printerId, data);
                    this.sendDataToBambuInterface(printerId, data);
                });
            }

            setupPostMessageProxy() {
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ postMessage –æ—Ç iframe Bambu Lab
                window.addEventListener('message', (event) => {
                    console.log('Received postMessage from iframe:', event.data);
                    
                    if (event.data.type === 'request-bambu-data') {
                        const printerId = event.data.printerId;
                        console.log('Proxying bambu data request to main process for printer:', printerId);
                        
                        // –ü—Ä–æ–∫—Å–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ main –ø—Ä–æ—Ü–µ—Å—Å —á–µ—Ä–µ–∑ IPC
                        ipcRenderer.send('request-bambu-data', printerId);
                    }
                });
            }

            addTab(printerData) {
                const tabId = printerData.id;
                console.log('Adding tab for printer:', printerData.name, 'ID:', tabId, 'Type:', printerData.type);
                
                if (this.tabs.has(tabId)) {
                    console.log('Tab already exists, focusing:', tabId);
                    this.focusTab(tabId);
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É
                const tabElement = document.createElement('div');
                tabElement.className = 'tab';
                tabElement.dataset.tabId = tabId;
                
                const printerIcon = printerData.type === 'bambu' ? 'üéã' : 'üñ®Ô∏è';
                tabElement.innerHTML = `
                    <span class="tab-name">${printerIcon} ${printerData.name}</span>
                    <button class="tab-close">√ó</button>
                `;

                const closeButton = tabElement.querySelector('.tab-close');
                closeButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.closeTab(tabId);
                });

                tabElement.addEventListener('click', () => {
                    this.focusTab(tabId);
                });

                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è iframe
                const iframeContainer = document.createElement('div');
                iframeContainer.className = 'iframe-container';
                iframeContainer.dataset.tabId = tabId;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–∏–Ω—Ç–µ—Ä–∞
                let printerUrl;
                let isBambu = printerData.type === 'bambu';
                
                if (isBambu) {
                    // –î–ª—è Bambu Lab –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    printerUrl = 'src/bambu-printer-interface.html';
                    console.log('Loading Bambu Lab interface:', printerData.name);
                } else {
                    // –î–ª—è Klipper –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–Ω—Ç–µ—Ä–∞
                    const webPortRaw = printerData.webPort;
                    const webPort = (webPortRaw && String(webPortRaw).trim() !== '') ? String(webPortRaw).trim() : '80';
                    printerUrl = `http://${printerData.ip}:${webPort}`;
                    console.log('Loading Klipper interface:', printerData.name, '-', printerUrl);
                }
                
                iframeContainer.innerHTML = `
                    <iframe 
                        src="${printerUrl}"
                        class="printer-iframe"
                        style="width: 100%; height: 100%; border: none;"
                        allow="autoplay; camera; microphone; display-capture"
                        allowfullscreen
                    ></iframe>
                    <div class="loading-indicator" id="loading-${tabId}">
                        <div class="loading-spinner"></div>
                        <p>${t('loading_interface')} ${printerData.name}...</p>
                    </div>
                `;

                const iframe = iframeContainer.querySelector('.printer-iframe');
                const loadingIndicator = iframeContainer.querySelector('.loading-indicator');

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π iframe
                iframe.addEventListener('load', () => {
                    console.log(`Iframe for ${printerData.name} loaded successfully`);
                    loadingIndicator.style.display = 'none';
                    
                    // –î–ª—è Bambu Lab –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º printer ID –≤ iframe
                    if (isBambu) {
                        try {
                            iframe.contentWindow.postMessage({ 
                                type: 'set-printer-id', 
                                printerId: tabId 
                            }, '*');
                            
                            // –¢–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ IPC –¥–ª—è —Å–≤—è–∑–∏ —Å main process
                            ipcRenderer.send('bambu-interface-ready', tabId);
                        } catch (error) {
                            console.error('Error sending printer ID to iframe:', error);
                        }
                    }
                });

                iframe.addEventListener('error', (event) => {
                    console.error(`Iframe for ${printerData.name} failed to load:`, event);
                    loadingIndicator.innerHTML = `
                        <div class="error-message">
                            <h3>‚ùå ${t('interface_load_failed')}</h3>
                            <p><strong>${t('printer')}:</strong> ${printerData.name}</p>
                            <p><strong>URL:</strong> ${printerUrl}</p>
                            <p><strong>${t('error')}:</strong> ${t('connection_error')}</p>
                            <p>${t('check_printer_connection')}</p>
                            <ul>
                                <li>${t('printer_powered_on')}</li>
                                <li>${t('network_working')}</li>
                                <li>${t('web_accessible')}</li>
                            </ul>
                            <button onclick="window.tabsManager.retryLoad('${tabId}', '${printerUrl}')" class="retry-btn">üîÑ ${t('retry_loading')}</button>
                        </div>
                    `;
                });

                // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ DOM
                document.getElementById('tabsContainer').appendChild(tabElement);
                document.getElementById('tabContent').appendChild(iframeContainer);

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∫–ª–∞–¥–∫—É
                this.tabs.set(tabId, {
                    element: tabElement,
                    container: iframeContainer,
                    iframe: iframe,
                    printer: printerData,
                    url: printerUrl,
                    isBambu: isBambu
                });

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É
                this.focusTab(tabId);

                // –°–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç –≤–∫–ª–∞–¥–æ–∫"
                document.getElementById('noTabsMessage').style.display = 'none';
                
                console.log('Tab added successfully:', tabId);
            }

            focusTab(tabId) {
                if (!this.tabs.has(tabId)) {
                    console.log('Tab not found for focusing:', tabId);
                    return;
                }

                console.log('Focusing tab:', tabId);

                // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
                this.tabs.forEach((tab, id) => {
                    tab.element.classList.remove('active');
                    tab.container.classList.remove('active');
                });

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
                const tab = this.tabs.get(tabId);
                tab.element.classList.add('active');
                tab.container.classList.add('active');
                
                this.activeTabId = tabId;
                console.log('Tab focused:', tabId);
            }

            closeTab(tabId) {
                if (!this.tabs.has(tabId)) {
                    console.log('Tab not found for closing:', tabId);
                    return;
                }

                console.log('Closing tab:', tabId);

                const tab = this.tabs.get(tabId);
                
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ DOM
                tab.element.remove();
                tab.container.remove();
                
                // –£–¥–∞–ª—è–µ–º –∏–∑ Map
                this.tabs.delete(tabId);

                // –£–≤–µ–¥–æ–º–ª—è–µ–º –≥–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                ipcRenderer.send('close-printer-tab', tabId);

                // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –¥—Ä—É–≥—É—é
                if (this.activeTabId === tabId) {
                    const remainingTabs = Array.from(this.tabs.keys());
                    if (remainingTabs.length > 0) {
                        this.focusTab(remainingTabs[0]);
                    } else {
                        this.activeTabId = null;
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–Ω–µ—Ç –≤–∫–ª–∞–¥–æ–∫"
                        document.getElementById('noTabsMessage').style.display = 'flex';
                    }
                }
                
                console.log('Tab closed:', tabId);
            }

            retryLoad(tabId, url) {
                if (this.tabs.has(tabId)) {
                    const tab = this.tabs.get(tabId);
                    const loadingIndicator = tab.container.querySelector('.loading-indicator');
                    const iframe = tab.iframe;
                    
                    loadingIndicator.innerHTML = `
                        <div class="loading-spinner"></div>
                        <p>${t('retry_loading')} ${tab.printer.name}...</p>
                    `;
                    loadingIndicator.style.display = 'flex';
                    
                    console.log('Retrying load for:', url);
                    iframe.src = url;
                }
            }

            sendDataToBambuInterface(printerId, data) {
                console.log('[sendDataToBambuInterface] Called for printer:', printerId);
                console.log('[sendDataToBambuInterface] Has tabs:', this.tabs.has(printerId));
                
                if (!this.tabs.has(printerId)) {
                    console.log('[sendDataToBambuInterface] Tab not found for Bambu data:', printerId);
                    console.log('[sendDataToBambuInterface] Available tabs:', Array.from(this.tabs.keys()));
                    return;
                }

                const tab = this.tabs.get(printerId);
                console.log('[sendDataToBambuInterface] Tab found:', tab);
                console.log('[sendDataToBambuInterface] Is Bambu?:', tab.isBambu);
                
                if (!tab.isBambu) {
                    console.log('[sendDataToBambuInterface] Tab is not Bambu type:', printerId);
                    return;
                }

                console.log('[sendDataToBambuInterface] Sending data to Bambu interface:', printerId, data);
                console.log('[sendDataToBambuInterface] Iframe exists?:', !!tab.iframe);
                console.log('[sendDataToBambuInterface] ContentWindow exists?:', !!(tab.iframe && tab.iframe.contentWindow));
                
                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ iframe —á–µ—Ä–µ–∑ postMessage
                    if (tab.iframe && tab.iframe.contentWindow) {
                        tab.iframe.contentWindow.postMessage({
                            type: 'bambu-data-update',
                            data: data
                        }, '*');
                        console.log('[sendDataToBambuInterface] postMessage sent successfully');
                    } else {
                        console.error('[sendDataToBambuInterface] iframe or contentWindow not available');
                    }
                } catch (error) {
                    console.error('[sendDataToBambuInterface] Error sending data to Bambu interface:', error);
                }
            }

            renderTabs() {
                document.getElementById('noTabsMessage').style.display = 'flex';
                console.log('Tabs manager rendered');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤–∫–ª–∞–¥–æ–∫
        function initTabsManager() {
            window.tabsManager = new PrinterTabsManager();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTabsManager);
        } else {
            // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            initTabsManager();
        }
    </script>
</body>
</html>