<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' data: https: http:; script-src 'self' 'unsafe-inline' 'unsafe-eval';">
    <title>Tom Tomich's 3D Printer Control Panel</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-main">
                <h1>🖨️ Tom Tomich's 3D Printer Control Panel</h1>
                <div class="app-version" id="appVersion">v—</div>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="openAddPrinterModal()">➕ Add Printer</button>
                <button class="btn btn-secondary" onclick="testAllConnections()">🔍 Test All Connections</button>
                <button class="btn btn-telegram" onclick="openTelegramSettingsModal()">🤖 Telegram</button>
                <button class="btn btn-secondary" onclick="openAnalyticsModal()">📈 <span id="analyticsBtnText">Analytics</span></button>
                <div class="interval-selector">
                    <label>Polling interval: </label>
                    <select id="pollingInterval" onchange="updatePollingInterval(this.value)">
                        <option value="10000">10 sec</option>
                        <option value="15000">15 sec</option>
                        <option value="20000">20 sec</option>
                        <option value="30000" selected>30 sec</option>
                        <option value="45000">45 sec</option>
                        <option value="60000">60 sec</option>
                        <option value="75000">75 sec</option>
                        <option value="90000">90 sec</option>
                    </select>
                </div>
            </div>
            <div class="printers-counter">
                <span class="counter printing">🖨️ <span id="count-printing">0</span></span>
                <span class="counter offline">🔌 <span id="count-offline">0</span></span>
                <span class="counter ready">✅ <span id="count-ready">0</span></span>
                <span class="counter complete">🏁 <span id="count-complete">0</span></span>
                <span class="counter paused">⏸️ <span id="count-paused">0</span></span>
                <span class="counter error">🚫 <span id="count-error">0</span></span>
            </div>
        </header>

        <main>
            <section class="card">
                <h2>📊 Printer Status</h2>
                <div id="printersContainer" class="printers-container"></div>
            </section>

            <section class="card">
                <h2>📋 Event Log</h2>
                <div class="console">
                    <div id="messageConsole" class="console-content"></div>
                    <div class="console-controls">
                        <button class="btn btn-small" onclick="clearConsole()">🗑️ Clear</button>
                        <button class="btn btn-small" onclick="exportLogs()">📥 Export</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add Printer Modal -->
    <div id="addPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>➕ Add Printer</h3>
                <span class="close" onclick="closeAddPrinterModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="printerType">Printer type:</label>
                    <select id="printerType" onchange="togglePrinterTypeFields('add')">
                        <option value="klipper">Klipper (Moonraker)</option>
                        <option value="bambu">Bambu Lab</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="printerName">Printer name:</label>
                    <input type="text" id="printerName" placeholder="My Printer">
                </div>
                <div class="form-group">
                    <label for="printerIP">IP address:</label>
                    <input type="text" id="printerIP" placeholder="192.168.1.100">
                </div>
                
                <!-- Klipper specific fields -->
                <div id="klipperFields" class="printer-type-fields">
                    <div class="form-group">
                        <label for="printerPort">Moonraker port:</label>
                        <input type="number" id="printerPort" value="7125" placeholder="7125">
                    </div>
                    <div class="form-group">
                        <label for="webInterfacePort">Web interface port (optional):</label>
                        <input type="number" id="webInterfacePort" placeholder="80">
                    </div>
                </div>
                
                <!-- Bambu Lab specific fields -->
                <div id="bambuFields" class="printer-type-fields" style="display: none;">
                    <div class="form-group">
                        <label for="accessCode">Access Code:</label>
                        <input type="text" id="accessCode" placeholder="12345678">
                        <small>Get from printer settings → Network → Access Code</small>
                    </div>
                    <div class="form-group">
                        <label for="serialNumber">Serial Number:</label>
                        <input type="text" id="serialNumber" placeholder="01P00A123456789">
                        <small>Find on printer label or in settings</small>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="bambuDevMode" checked>
                            Developer Mode enabled on printer
                        </label>
                        <small style="display: block; margin-top: 5px;">⚠️ Developer mode must be enabled in printer settings</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="addPrinter()">Add</button>
                    <button class="btn" onclick="closeAddPrinterModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Printer Modal -->
    <div id="editPrinterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>✏️ Edit Printer</h3>
                <span class="close" onclick="closeEditPrinterModal()">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPrinterId">
                <div class="form-group">
                    <label for="editPrinterType">Printer type:</label>
                    <select id="editPrinterType" onchange="togglePrinterTypeFields('edit')">
                        <option value="klipper">Klipper (Moonraker)</option>
                        <option value="bambu">Bambu Lab</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPrinterName">Printer name:</label>
                    <input type="text" id="editPrinterName">
                </div>
                <div class="form-group">
                    <label for="editPrinterIP">IP address:</label>
                    <input type="text" id="editPrinterIP" placeholder="192.168.1.100">
                </div>
                
                <!-- Klipper specific fields -->
                <div id="editKlipperFields" class="printer-type-fields">
                    <div class="form-group">
                        <label for="editPrinterPort">Moonraker port:</label>
                        <input type="number" id="editPrinterPort" placeholder="7125">
                    </div>
                    <div class="form-group">
                        <label for="editWebInterfacePort">Web interface port (optional):</label>
                        <input type="number" id="editWebInterfacePort" placeholder="80">
                    </div>
                </div>
                
                <!-- Bambu Lab specific fields -->
                <div id="editBambuFields" class="printer-type-fields" style="display: none;">
                    <div class="form-group">
                        <label for="editAccessCode">Access Code:</label>
                        <input type="text" id="editAccessCode" placeholder="12345678">
                        <small>Get from printer settings → Network → Access Code</small>
                    </div>
                    <div class="form-group">
                        <label for="editSerialNumber">Serial Number:</label>
                        <input type="text" id="editSerialNumber" placeholder="01P00A123456789">
                        <small>Find on printer label or in settings</small>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="savePrinterChanges()">Save</button>
                    <button class="btn" onclick="closeEditPrinterModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Telegram Settings Modal -->
    <div id="telegramSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🤖 Telegram Settings</h3>
                <span class="close" onclick="closeTelegramSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="telegramBotToken">Bot Token:</label>
                    <input type="text" id="telegramBotToken" placeholder="1234567890:ABCdefGHIjklMNopQRstUVwxyz">
                    <small>Get this from @BotFather in Telegram</small>
                </div>
                <div class="form-group">
                    <label for="telegramChatId">Chat ID:</label>
                    <input type="text" id="telegramChatId" placeholder="123456789">
                    <small>Send /start to your bot and check logs</small>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="telegramEnabled"> <span id="labelEnableTelegram">Enable Telegram notifications</span>
                    </label>
                </div>
                <div class="notification-settings">
                    <h4 id="telegramNotifyTitle">Notify on:</h4>
                    <label><input type="checkbox" id="notifyPrintComplete" checked> <span id="labelPrintComplete">Print complete</span></label>
                    <label><input type="checkbox" id="notifyPrintError" checked> <span id="labelPrintError">Print error</span></label>
                    <label><input type="checkbox" id="notifyPrintPaused" checked> <span id="labelPrintPaused">Print paused</span></label>
                    <label><input type="checkbox" id="notifyPrinterOffline"> <span id="labelPrinterOffline">Printer offline</span></label>
                    <label><input type="checkbox" id="notifyPrinterOnline"> <span id="labelPrinterOnline">Printer online</span></label>
                    <label><input type="checkbox" id="notifyInefficiency" checked> <span id="labelInefficiency">Inefficiency event</span></label>
                    <label><input type="checkbox" id="notifyInefficiencyReason" checked> <span id="labelInefficiencyReason">Inefficiency reason saved</span></label>
                    <label><input type="checkbox" id="notifyProgramStart" checked> <span id="labelProgramStart">Program start</span></label>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-help" onclick="openTelegramHelp()" style="margin-right: auto;">❓ Help</button>
                    <button class="btn btn-primary" onclick="saveTelegramSettings()">Save</button>
                    <button class="btn btn-secondary" onclick="testTelegramConnection()">Test Connection</button>
                    <button class="btn" onclick="closeTelegramSettingsModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content" style="max-width: 1100px;">
            <div class="modal-header">
                <h3>📈 Analytics</h3>
                <span class="close" onclick="closeAnalyticsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group" style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                    <div>
                        <label id="analyticsPeriodLabel">Период:</label>
                        <select id="analyticsPeriod">
                            <option value="1d">За день</option>
                            <option value="7d">За неделю</option>
                            <option value="30d">За месяц</option>
                            <option value="custom">Произвольный</option>
                        </select>
                    </div>
                    <div>
                        <label id="analyticsPrinterLabel">Принтер:</label>
                        <select id="analyticsPrinter"></select>
                    </div>
                    <div id="analyticsCustomRange" style="display:none; gap:10px; align-items:end;">
                        <div>
                            <label id="analyticsFromLabel">С</label>
                            <input type="date" id="analyticsFrom" />
                        </div>
                        <div>
                            <label id="analyticsToLabel">По</label>
                            <input type="date" id="analyticsTo" />
                        </div>
                    </div>
                </div>

                <div class="printers-counter" style="margin-top:10px;">
                    <span class="counter printing"><span id="stat-print-time">0s</span><span style="margin-left:6px;" id="kpiPrintLabel">Общее время печати</span></span>
                    <span class="counter ready"><span id="stat-idle-time">0s</span><span style="margin-left:6px;" id="kpiIdleLabel">Общее время простоя</span></span>
                    <span class="counter complete"><span id="stat-efficiency">0.0%</span><span style="margin-left:6px;" id="kpiEffLabel">Эффективность</span></span>
                    <span class="counter error"><span id="stat-energy-cost">0</span><span style="margin-left:6px;" id="kpiCostLabel">Стоимость энергии</span></span>
                </div>

                <div class="tabs" style="display:flex; gap:20px; margin-top:15px;">
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('eff')" id="tabEffBtn">Эффективность</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('ineff')" id="tabIneffBtn">Неэффективность</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('energy')" id="tabEnergyBtn">Энергопотребление</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('details')" id="tabDetailsBtn">Детальная статистика</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('settings')" id="tabSettingsBtn">Настройки</button>
                    <button class="btn btn-secondary btn-small" onclick="setAnalyticsTab('help')" id="tabHelpBtn">❓ Помощь</button>
                </div>

                <div id="analyticsTabContent" style="margin-top:10px;">
                    <!-- content filled by renderer.js -->
                </div>
            </div>
        </div>
    </div>

    <!-- Inefficiency Comment Modal -->
    <div id="inefficiencyCommentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="ineffCommentModalTitle">📝 Add Comment</h3>
                <span class="close" onclick="closeInefficiencyCommentModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <h4 id="ineffCommentPrinterName" style="color: #00d4ff; margin-bottom: 5px;">Printer Name</h4>
                    <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px; color: #888;">
                        <span><strong id="ineffCommentTypeLabel">Type:</strong> <span id="ineffCommentType">Gap</span></span>
                        <span><strong id="ineffCommentDurationLabel">Duration:</strong> <span id="ineffCommentDuration">15m</span></span>
                    </div>
                    <div style="margin-top: 8px; font-size: 13px; color: #666;">
                        <span id="ineffCommentPeriod">Period: 2024-01-01 10:00 - 10:15</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="ineffCommentTextarea" id="ineffCommentLabel">Comment / Reason:</label>
                    <textarea 
                        id="ineffCommentTextarea" 
                        rows="5" 
                        placeholder="Enter the reason for this inefficiency period..."
                        style="width: 100%; padding: 10px; border: 1px solid #444; background: #2a2a2a; color: #fff; border-radius: 5px; font-family: inherit; resize: vertical;"
                    ></textarea>
                    <small id="ineffCommentHint" style="color: #888; display: block; margin-top: 5px;">
                        💡 Example: Material change, maintenance, waiting for parts, operator break, etc.
                    </small>
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveInefficiencyComment()">
                        <span id="ineffCommentSaveBtn">💾 Save Comment</span>
                    </button>
                    <button class="btn btn-danger" onclick="deleteInefficiencyComment()" id="ineffCommentDeleteBtn" style="display: none;">
                        <span id="ineffCommentDeleteText">🗑️ Delete</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeInefficiencyCommentModal()">
                        <span id="ineffCommentCancelBtn">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Analytics Confirmation Modal -->
    <div id="clearAnalyticsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="clearAnalyticsModalTitle">⚠️ Clear Analytics Data</h3>
                <span class="close" onclick="closeClearAnalyticsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="clearAnalyticsWarning1" style="font-size: 16px; line-height: 1.6; color: #e74c3c; font-weight: bold;">
                    ⚠️ Warning! This action is irreversible!
                </p>
                <p id="clearAnalyticsWarning2" style="font-size: 14px; line-height: 1.6; margin-top: 15px;">
                    All analytics data will be permanently deleted, including:
                </p>
                <ul style="margin-top: 10px; line-height: 1.8;">
                    <li id="clearAnalyticsItem1">Print and idle time history</li>
                    <li id="clearAnalyticsItem2">All status transition events</li>
                    <li id="clearAnalyticsItem3">Inefficiency periods and operator reports</li>
                    <li id="clearAnalyticsItem4">Energy consumption statistics</li>
                </ul>
                <p id="clearAnalyticsWarning3" style="font-size: 14px; line-height: 1.6; margin-top: 15px; color: #888;">
                    Power settings (wattage, cost per kWh) will be preserved.
                </p>
                <p id="clearAnalyticsConfirm" style="font-size: 14px; line-height: 1.6; margin-top: 15px; font-weight: bold;">
                    Are you sure you want to continue?
                </p>
                <div class="modal-footer" style="margin-top: 20px; gap: 10px;">
                    <button class="btn btn-danger" onclick="confirmClearAnalytics()">
                        <span id="clearAnalyticsYesBtn">Yes, Clear All Data</span>
                    </button>
                    <button class="btn btn-secondary" onclick="closeClearAnalyticsModal()">
                        <span id="clearAnalyticsNoBtn">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bambu Lab Info Modal -->
    <div id="bambuInfoModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="bambuInfoModalTitle">🎋 Bambu Lab</h3>
                <span class="close" onclick="closeBambuInfoModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="font-size: 16px; line-height: 1.6;">
                    <strong id="bambuPrinterName"></strong>
                </p>
                <p id="bambuInfoMessage" style="font-size: 14px; line-height: 1.6; margin-top: 15px;">
                    ℹ️ Bambu Lab printers use mobile app <strong>Bambu Handy</strong> or <strong>Bambu Studio</strong> for control.
                </p>
                <p id="bambuInfoNoWeb" style="font-size: 14px; line-height: 1.6; margin-top: 10px; color: #888;">
                    There is no local web interface available for this printer type.
                </p>
                <div class="modal-footer" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="closeBambuInfoModal()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio element for completion sound -->
    <audio id="completionSound" preload="auto">
        <source src="windows-xp-print-complete.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script src="translations.js"></script>
    <script src="renderer.js"></script>
</body>
</html>